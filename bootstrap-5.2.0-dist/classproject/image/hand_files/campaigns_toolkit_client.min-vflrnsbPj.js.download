define(["require","exports","tslib","react","lodash","metaserver/static/js/campaigns/emitter","metaserver/static/js/campaigns/api","metaserver/static/js/core/exception","metaserver/static/js/onboarding/logging/events","metaserver/static/js/campaigns/fullscreen_formats","metaserver/static/js/campaigns/utils/logging","metaserver/static/js/campaigns/types","metaserver/static/js/campaigns/history_utils"],(function(e,t,a,n,i,s,c,o,r,p,g,m,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CampaignsToolkit=t.fetchCampaigns=void 0,n=a.__importStar(n),c=a.__importStar(c),o=a.__importStar(o);t.fetchCampaigns=(e={},t)=>a.__awaiter(void 0,void 0,void 0,(function*(){try{const a=[],{campaigns_result:n,campaigns_to_slots:i}=yield c.getBestCampaignsForUser({campaign_properties:e,event_context:{file_extension:(null==t?void 0:t.file_extension)&&t.file_extension,file_name:(null==t?void 0:t.file_name)&&t.file_name,upload_error_type:(null==t?void 0:t.upload_error_type)&&t.upload_error_type}});return null==n||n.campaigns.forEach(e=>{var t,s;a.push({campaign:e,requestId:null==n?void 0:n.request_id,slotId:null!==(t=null==i?void 0:i[e.version_id])&&void 0!==t?t:{".tag":"other"},currentSequenceStep:null===(s=e.sequence)||void 0===s?void 0:s.root})}),a}catch(t){o.reportException({err:t,tags:["fetchCampaigns","campaigns"],severity:o.SEVERITY.NONCRITICAL,exc_extra:{args:e}})}return[]}));const u=e=>{const t={};return e.forEach(e=>{e.currentSequenceStep&&(t[e.campaign.campaign_id]=e.currentSequenceStep)}),t},d=[m.CampaignEvents.SHARE_MODAL_CLOSED];t.CampaignsToolkit=({emitter:e=s.campaignsEmitter})=>{const[{campaigns:c,page:o,context:m,sequenceMap:_},v]=(0,n.useState)({campaigns:[],page:"",context:void 0,sequenceMap:{}});return(0,n.useEffect)(()=>{const t=({data:{page:e,context:t}})=>{v(a=>Object.assign(Object.assign({},a),{page:e,context:t})),(0,l.resetHistoryForEvent)(s.PAGE_LOADED)};return e.on(s.PAGE_LOADED,t),()=>{e.off(s.PAGE_LOADED,t)}},[]),(0,n.useEffect)(()=>{const t=e=>{const t=c.filter(t=>{var a;const n=null===(a=null==t?void 0:t.campaign)||void 0===a?void 0:a.campaign_id;return!!n&&String(n)!==e}),a=(0,i.cloneDeep)(_);delete a[parseInt(e,10)],v(e=>Object.assign(Object.assign({},e),{campaigns:t,sequenceMap:a}))};return e.on(s.CAMPAIGN_DISMISSED,t),()=>{e.off(s.CAMPAIGN_DISMISSED,t)}},[c]),(0,n.useEffect)(()=>{const t=({campaignId:e,ctaId:t})=>{var a,n,o;const p=parseInt(e,10),m=c.find(e=>e.campaign.campaign_id===p),l=null==m?void 0:m.currentSequenceStep,u=null!==(n=null===(a=null==m?void 0:m.campaign.sequence)||void 0===a?void 0:a.nodes)&&void 0!==n?n:{},d={campaign:{campaign_id:p,version_id:-1,prompt_queried_at_ms:-1,campaign_name:"campaignWithOnlyCampaignId"},requestId:"",slotId:{".tag":"other"}};if(!(m&&l&&t&&l in u))return void(0,g.logCampaignSequenceEvent)(r.CampaignsToolkitSequenceEvents.MISSING_OR_INVALID_PARAMETERS,null!=m?m:d,l,t);const f=null===(o=u[l].children)||void 0===o?void 0:o[t];if(!f)return(0,g.logCampaignSequenceEvent)(r.CampaignsToolkitSequenceEvents.SEQUENCE_COMPLETED,m,l,t),void(0,s.emitCampaignDismissed)(e);const E=Object.assign(Object.assign({},m),{currentSequenceStep:f}),S=c.map(e=>e.campaign.campaign_id===p?E:e),C=(0,i.cloneDeep)(_);C[p]=f,v(e=>Object.assign(Object.assign({},e),{campaigns:S,sequenceMap:C})),(0,s.emitCampaignToSlot)(E)};return e.on(s.CAMPAIGN_SEQUENCE_ACTION,t),()=>{e.off(s.CAMPAIGN_SEQUENCE_ACTION,t)}},[c,_]),(0,n.useEffect)(()=>{const n=({name:e,data:{context:n,loggingParams:c}={}})=>a.__awaiter(void 0,void 0,void 0,(function*(){if(!d.includes(e))return;const a=yield(0,t.fetchCampaigns)({page:o,action:e},n),r=u(a);v(e=>Object.assign(Object.assign({},e),{campaigns:(0,i.uniqBy)([...e.campaigns,...a].reverse(),s.getSlotFromCampaignFormatProps),sequenceMap:Object.assign(Object.assign({},e.sequenceMap),r)})),a.forEach(e=>{(0,s.emitCampaignToSlot)(e,n,c)})}));return e.on(s.CAMPAIGN_EVENT,n),()=>{e.off(s.CAMPAIGN_EVENT,n)}},[o]),(0,n.useEffect)(()=>{o&&a.__awaiter(void 0,void 0,void 0,(function*(){const e=yield(0,t.fetchCampaigns)({page:o},m),a=u(e);v(t=>Object.assign(Object.assign({},(0,i.omit)(t,"context")),{campaigns:e,sequenceMap:a})),e.forEach(e=>(0,s.emitCampaignToSlot)(e))}))},[o]),n.default.createElement(p.FullscreenFormats,null)}}));
//# sourceMappingURL=campaigns_toolkit_client.min.js-vflAP0oiS.map