define("metaserver/static/js/devtools/panels/performance/perf_hub_actions",["require","exports","metaserver/static/js/devtools/panels/performance/perf_hub_action_types","metaserver/static/js/flux/dispatcher"],(function(e,t,i,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PerfHubActions=void 0;t.PerfHubActions=new class{add_ajax_profile(e,t,s,r){const a=r;return n.Dispatcher.dispatch({type:i.ActionTypes.PROFILED_AJAX_LOAD_FINISHED,data:{url:e,serverResponseTime:t,profileRequestId:s,traceId:a}})}add_web_timing_details(e){return n.Dispatcher.dispatch({type:i.ActionTypes.WEB_TIMING_FETCHED,data:e})}add_visually_complete(e){return n.Dispatcher.dispatch({type:i.ActionTypes.VISUALLY_COMPLETE,data:e})}}})),define("metaserver/static/js/metrics/index",["require","exports","tslib","typescript/libraries/shared/apex-metrics/src/index","typescript/libraries/shared/apex-metrics/src/sink/index","metaserver/static/js/metrics/unload","metaserver/static/js/metrics/server_view_sink","metaserver/static/js/core/exception","metaserver/static/js/core/browser_detection","metaserver/static/js/uuid/insecure_uuid"],(function(e,t,i,n,s,r,a,o,c,l){"use strict";function d(){return new n.BrowserPerformanceClock}function u(){return i.__awaiter(this,void 0,void 0,(function*(){const{NoAuthApiV2Client:t}=yield new Promise((t,i)=>{e(["metaserver/static/js/api_v2/noauth_client"],t,i)}).then(i.__importStar),n=new t;return p(n)}))}Object.defineProperty(t,"__esModule",{value:!0}),t.getUnloadMetricsReporter=t.getMetricsReporter=void 0,o=i.__importStar(o),c=i.__importStar(c);const p=e=>({clientMetricsRecord:t=>e.ns("client_metrics").rpc("record",t,{}).then(e=>({result:e}))});function m(){return()=>l.InsecureUUID.v4()}function _(){return{detectBrowser:h,detectOS:g}}function h(){const e=[[!!c.chrome,"chrome"],[!!c.edge,"edge"],[!!c.mozilla,"firefox"],[!!c.msie,"msie"],[!!c.safari,"safari"]];for(const t of e)if(t[0])return t[1];return"other"}function g(){return c.mac?{name:{".tag":"mac"},version:"unknown"}:c.windows?{name:{".tag":"windows"},version:(e=c.windowsInfo,e.windowsXP||e.windowsXPx64?"XP":e.windowsVista?"Vista":e.windows7?"7":e.windows8?"8":e.windows8_1?"8.1":e.windows10?"10 Unknown":"unknown")}:c.is_android()?{name:{".tag":"android"},version:"unknown"}:c.iOS?{name:{".tag":"ios"},version:"unknown"}:{name:{".tag":"unknown_os"},version:"unknown"};var e}const f=(0,s.makeDefaultCacheFactory)();const v=new a.ServerViewMetricsSink;t.getMetricsReporter=function(){const e=(0,s.getSinkSingleton)({clientFactory:u,platformDetector:_(),exceptionReporter:o,identifierFactory:m()});return void 0!==window._clientBridge?n.MetricsReporterImpl.root(v,d(),e.getOriginId()):n.MetricsReporterImpl.root(e,d(),e.getOriginId())},t.getUnloadMetricsReporter=function(){const e=(0,s.getSinkSingleton)({clientFactory:u,platformDetector:_(),exceptionReporter:o,identifierFactory:m()}),t=(function(e){void 0===e&&(e=u);const t=(0,s.getSinkSingleton)({clientFactory:e});if(window.unloadSinkSingleton)return window.unloadSinkSingleton;const i=new r.UnloadSink(f,t);return window.unloadSinkSingleton=i,i})();return n.MetricsReporterImpl.root(t,d(),e.getOriginId())}})),define("metaserver/static/js/metrics/server_view_sink",["require","exports","tslib"],(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ServerViewMetricsSink=void 0;t.ServerViewMetricsSink=class{constructor(){this.spans=[],this.bridgeInitialized=!1}recordSpan(e){this.spans.push(e),this.bridgeInitialized||this.initializeBridgeSink()}recordSetSpan(e){}initializeBridgeSink(){return i.__awaiter(this,void 0,void 0,(function*(){this.bridgeInitialized=!0;const t=yield new Promise((t,i)=>{e(["metaserver/static/js/clean/server_side_client_view_bridge"],t,i)}).then(i.__importStar);(yield t.IsBridgeFunctionSupported("reportMetricsV2"))?(setInterval(()=>{this.spans.length>0&&(t.ReportMetrics(this.spans),this.spans=[])},5e3),window.addEventListener("beforeunload",()=>{this.spans.length>0&&(console.log(`Attempting to send ${this.spans.length} pending AMP spans`),t.ReportMetrics(this.spans),this.spans=[])})):setInterval((function(){this.spans=[]}),6e4)}))}}})),define("metaserver/static/js/metrics/unload",["require","exports","tslib","eventemitter3"],(function(e,t,i,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UnloadSink=void 0,n=i.__importDefault(n);t.UnloadSink=class{constructor(e,t){this.cacheFactory=e,this.innerSink=t,this.eventEmitter=new n.default,this.onUnloadChange=()=>{this.isUnload()||this.flushToInner()},this.persistor=new r(this.cacheFactory()),this.listener=new s(this.onUnloadChange),this.onUnloadChange()}flushToInner(){this.persistor.getAllAndClear().forEach(e=>{this.recordSpanToInner(e)})}isUnload(){return Boolean(this.listener.isUnload)}recordSpan(e){if(this.isUnload())return this.persistor.persistSpans([e]),void this.eventEmitter.emit("spansPersistedInUnload");this.recordSpanToInner(e)}recordSetSpan(e){}recordSpanToInner(e){const t=Object.assign(Object.assign({},e),{fromUnloadSink:!0});this.innerSink.recordSpan(t)}};class s{constructor(e){this.onUnloadChange=e,this._isUnload=!1,this.listenForNavigationChanges()}get isUnload(){return this._isUnload}set isUnload(e){this._isUnload!==e&&(this._isUnload=e,this.onUnloadChange())}listenForNavigationChanges(){if("undefined"!=typeof window&&"function"==typeof window.addEventListener&&"function"==typeof document.addEventListener){const e=()=>{"hidden"===document.visibilityState?this.isUnload=!0:"visible"===document.visibilityState&&(this.isUnload=!1)},t=()=>{this.isUnload=!0,window.removeEventListener("pagehide",t),document.removeEventListener("visibilitychange",e)};window.addEventListener("pagehide",t),document.addEventListener("visibilitychange",e)}}}class r{constructor(e){this.cache=e,this.CACHE_KEY="amp-persisted-spans-v2",this.OLD_CACHE_KEY="amp-persisted-spans"}getAllAndClear(){if(!this.cache)return[];const e=this.retrieveSpans();try{this.cache.setItem(this.CACHE_KEY,JSON.stringify([])),this.cache.removeItem(this.OLD_CACHE_KEY)}catch(e){}return e}persistSpans(e){if(!this.cache||!e)return;const t=this.retrieveSpans();t.push(...e);try{this.cache.setItem(this.CACHE_KEY,JSON.stringify(t))}catch(e){}}retrieveSpans(){let e=[];try{e=JSON.parse(this.cache.getItem(this.CACHE_KEY))}catch(e){}return e||[]}}})),define("metaserver/static/js/perf_tools/resource_utils",["require","exports","tslib","metaserver/static/js/clean/js_client_stopwatch","metaserver/static/js/perf_tools/cpu_utils"],(function(e,t,i,n,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.summarizePerformanceResourceTimings=t.logResourceTiming=t.logResourcesData=void 0,s=i.__importStar(s),t.logResourcesData=function(e){(function(e){const t=window.requireContexts;if(!t)return;const i=s.listExecutionPerfMeasurementsForRequireContexts(t),r=n.JSStopwatch.createDetachedStopwatch("resource_init_timeline",e);i.forEach(e=>{const t=r.startSpan(e.name,{startTime:e.startTime});r.addSpanAnnotation(e.name,"totalTimeNs",Math.round(1e6*e.totalTime).toString(),t),r.endSpan(e.name,{endTime:e.startTime+e.totalTime,spanId:t})}),r.logData()})(e),(function(e){const t=n.JSStopwatch.createDetachedStopwatch("resource_timeline",e),i={},s=window.performance.getEntriesByType("resource");if(s instanceof Array)for(const e of s){let n=a(e);if(!n)continue;const s=i[n]||0;i[n]=s+1,s>0&&(n=`${n}-${s}`);const r=t.startSpan(n,{startTime:e.startTime,async:!0}),c=o(e);t.addSpanAnnotation(n,"type",c,r),0===e.transferSize?t.addSpanAnnotation(n,"cached","true",r):void 0===e.transferSize?t.addSpanAnnotation(n,"cached","unknown",r):t.addSpanAnnotation(n,"cached","false",r),e.responseEnd<e.startTime?(t.addSpanAnnotation(n,"negativeSpanLength",(e.responseEnd-e.startTime).toString(),r),t.endSpan(n,{endTime:e.startTime,spanId:r})):t.endSpan(n,{endTime:e.responseEnd,spanId:r})}t.logData()})(e)};const r=document&&document.createElement?document.createElement("a"):null;function a(e){if(r){if(r.href=e.name,r.host.match(/dropboxstatic.com$/)&&r.pathname.match(/^\/static/)){let e=r.pathname;const t=e.match(/vfl[a-zA-Z0-9]*\.[a-z]*$/);t&&t.index&&(e=e.substring(0,t.index-1));const i="/static/";return e.startsWith(i)&&(e=e.substring(i.length)),e}return r.host.match(/photos-[0-9]+.dropbox.com$/)&&r.pathname.match(/^\/t\/2/)?"/thumbnail":void 0}}function o(e){const{name:t,initiatorType:i}=e,n=t.lastIndexOf(".");if(n>0){const e=t.substring(n);if([".png",".gif",".jpg",".svg"].indexOf(e)>-1)return"img";if(".js"===e)return"script";if(".css"===e)return"css"}return-1===["css","img","script","link"].indexOf(i)?"xmlhttprequest"===i?"ajax":"other":i}t.logResourceTiming=function(e){const t=window.performance.getEntriesByType("resource").filter(t=>-1!==t.name.indexOf(e))[0];if(!t||!t.responseEnd)return;const i=`resource_response_end_${e}`;return n.JSStopwatch.create_stopwatch_if_not_exist("resource_timing"),n.JSStopwatch.recordTrace(i,{stopwatchName:"resource_timing",traceTime:t.responseEnd}),t},t.summarizePerformanceResourceTimings=function(e,t){const i={pre:{},total:{}};if(n.JSStopwatch.create_stopwatch_if_not_exist("resource_timeline"),e instanceof Array)for(const n of e){const e=o(n),s=[];t&&n.responseEnd<=t&&(e in i.pre||(i.pre[e]={count:0,total_time:0,last_transfer_end:0}),s.push(i.pre[e])),e in i.total||(i.total[e]={count:0,total_time:0,last_transfer_end:0}),s.push(i.total[e]),s.forEach((function(t){var i;t.count++,t.total_time+=n.duration,t.last_transfer_end=Math.max(t.last_transfer_end,n.responseEnd),("css"===(i=e)||"script"===i||"img"===i)&&void 0!==n.transferSize&&void 0!==n.encodedBodySize&&n.encodedBodySize<Number.MAX_SAFE_INTEGER&&(t.total_size=t.total_size||0,t.transfer_size=t.transfer_size||0,0!==n.transferSize&&(t.transfer_size+=n.encodedBodySize),t.total_size=t.total_size||0,t.total_size+=n.encodedBodySize)}))}return i}})),define("metaserver/static/js/perf_tools/cpu_utils",["require","exports","metaserver/static/js/clean/js_client_stopwatch"],(function(e,t,i){"use strict";var n;function s(e){if(e.require&&e.require.perfMeasurements){let t=0;return e.require.perfMeasurements.map(({name:e,startTime:i,totalTime:n})=>(e.endsWith("anon")&&(e+="-"+t++),{jsExecutionType:c(e),name:e,startTime:i,totalTime:n}))}{const t=e.module_callback_times;return Object.keys(t).filter(e=>t[e].callbackDuration&&t[e].callbackTime).map(e=>({jsExecutionType:c(e),name:e,startTime:t[e].callbackTime,totalTime:t[e].callbackDuration}))}}function r(e){let t=[];for(const i in e)if(e.hasOwnProperty(i)){const n=e[i];t=t.concat(s(n))}return t}function a(e){return Object.keys(e).map(t=>{const i=e[t];return{measurement:{jsExecutionType:o(t),name:t,startTime:i.start,totalTime:i.end-i.start},annotations:i.annotations}})}function o(e){return e.startsWith("dws-processChunk")?n.DWS:n.UNKNOWN}function c(e){return e.startsWith("execCb.anon")||e.startsWith("overhead.anon")||e.startsWith("execCb.require-tier")||e.startsWith("overhead.require-tier")?n.OTHER:e.startsWith("execCb")||e.startsWith("overhead")?n.MODULE:n.UNKNOWN}Object.defineProperty(t,"__esModule",{value:!0}),t.logCumulativeExecutionTimes=t.cumulativeExecutionTimesBefore=t.listAnnotatedExecutionPerfMeasurementsForEnsemble=t.listExecutionPerfMeasurementsForRequireContexts=t.getAllGlobalExecutionPerfMeasurements=t.ALL_JS_EXECUTION_TYPES=t.JSExecutionType=void 0,(function(e){e.DWS="dws",e.MODULE="module",e.OTHER="other",e.UNKNOWN="unknown"})(n=t.JSExecutionType||(t.JSExecutionType={})),t.ALL_JS_EXECUTION_TYPES=[n.DWS,n.MODULE,n.OTHER,n.UNKNOWN],t.getAllGlobalExecutionPerfMeasurements=function(){let e=[];return window.ensemble&&window.ensemble.getJSStopwatchData&&(e=e.concat(a(window.ensemble.getJSStopwatchData()).map(({measurement:e})=>e))),window.requireContexts&&(e=e.concat(r(window.requireContexts))),e},t.listExecutionPerfMeasurementsForRequireContexts=r,t.listAnnotatedExecutionPerfMeasurementsForEnsemble=a,t.cumulativeExecutionTimesBefore=function(e,t){const i={};for(const n in e)if(e.hasOwnProperty(n)){const s=e[n];i[n]={},t.forEach(e=>{0<e.startTime&&e.startTime<s&&(i[n][e.jsExecutionType]=i[n][e.jsExecutionType]||0,i[n][e.jsExecutionType]+=e.totalTime)})}return i},t.logCumulativeExecutionTimes=function(e,n){const s=i.JSStopwatch.createDetachedStopwatch("cumulative_cpu_time",e);for(const e in n)n.hasOwnProperty(e)&&t.ALL_JS_EXECUTION_TYPES.forEach(t=>{s.recordTrace(`cpu_before_${e}_due_to_${t}`,n[e][t]||0)});s.logData()}})),define("metaserver/static/js/perf_tools/browser_perf_utils",["require","exports","tslib","metaserver/static/js/core/xhr","metaserver/static/js/modules/constants/request","metaserver/static/js/clean/js_client_stopwatch","metaserver/static/js/modules/constants/webtiming"],(function(e,t,i,n,s,r,a){"use strict";function o(e){const t=window.performance.timing,i={navigation_start:t.navigationStart,unload_event_start:t.unloadEventStart,unload_event_end:t.unloadEventEnd,redirect_start:t.redirectStart,redirect_end:t.redirectEnd,fetch_start:t.fetchStart,domain_lookup_start:t.domainLookupStart,domain_lookup_end:t.domainLookupEnd,connect_start:t.connectStart,secure_connect_start:t.secureConnectionStart,connect_end:t.connectEnd,request_start:t.requestStart,response_start:t.responseStart,response_end:t.responseEnd,dom_loading:t.domLoading,dom_interactive:t.domInteractive,dom_content_loaded_event_start:t.domContentLoadedEventStart,dom_content_loded_event_end:t.domContentLoadedEventEnd,dom_complete:t.domComplete,load_event_start:t.loadEventStart,load_event_end:t.loadEventEnd},o={};o.request_id=s.REQUEST_ID,o.referrer=document.referrer;const c=r.JSStopwatch.createDetachedStopwatch("browser_perf",e);for(const e in i)i.hasOwnProperty(e)&&(o[e]=i[e],i[e]&&c.recordTrace(e,i[e]-t.navigationStart));c.logData(),a.LOG_BROWSER_PERFORMANCE_INFO&&n.sendXhr("/alternate_wtl_browser_performance_info",o)}Object.defineProperty(t,"__esModule",{value:!0}),t.logBrowserPerformanceInfo=t.logBrowserPerfData=void 0,n=i.__importStar(n),s=i.__importStar(s),a=i.__importStar(a),t.logBrowserPerfData=function(e){(function(e){const t=r.JSStopwatch.createDetachedStopwatch("performance_marks",e),i=window.performance.getEntriesByType("mark");if(i instanceof Array)for(const e of i)t.recordTrace(e.name,e.startTime);t.logData()})(e),o(e)},t.logBrowserPerformanceInfo=o})),define("metaserver/static/js/perf_tools/web_timing_logger_types",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebTimerEvent=t.NavigationType=void 0;class i{static getFromNavigation(e){switch(e.type){case e.TYPE_NAVIGATE:return i.NAVIGATE;case e.TYPE_RELOAD:return i.RELOAD;case e.TYPE_BACK_FORWARD:return i.BACK_FORWARD}}}t.NavigationType=i,i.NAVIGATE="navigate",i.RELOAD="reload",i.BACK_FORWARD="back_forward";class n{constructor(e,t,i=!1,s=!0,r){this.name=e,this.flag=1<<t,this.triggersLogging=i,this.timestampPrefix=r||e,this.ordered=s,n.allEvents.push(this)}}t.WebTimerEvent=n,n.allEvents=[],n.APPLICATION_START=new n("application_code_start",1),n.LOAD_END=new n("load_end",2,!0,!1),n.MARK_TIME_TO_VIEW=new n("mark_time_to_view",3,!0,!0,"TTV"),n.FETCHED_DATA_FOR_TTI=new n("fetched_data_required_for_tti",4),n.MARK_TIME_TO_INTERACTIVE=new n("mark_time_to_interactive",5),n.TIME_TO_INTERACTIVE=new n("time_to_interactive",6,!0,!0,"TTI")})),define("metaserver/static/js/perf_tools/web_timing_utils",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CancellableCallback=t.WebTimingUtil=void 0;class i{static generateCorrelationId(){return Math.random().toString(36).substring(2)}static getNow(){const e=window.performance;return Math.floor((e.timeOrigin||e.timing.navigationStart)+e.now())}static newContext(e,t="unnamed_timer"){let n;if(e)n=i.getNow();else{const e=window.performance;n=Math.floor(e.timeOrigin||e.timing.navigationStart)}return{initialized:!1,is_pagelet:!1,is_dws:!1,is_dws2:!1,is_early_ensemble:!1,log_time_to_view:!1,log_time_to_interactive:!1,ttv_at_dom_interactive:!1,tti_at_dom_interactive:!1,source_type:"web",subtypes:{},tti_exclusion_flow:"",have_logged_web_timing:!1,delayed_tti_for_css:!1,rollup_format:"off",timing_results:null,start_time:n,time_to_view:null,time_to_interactive:null,correlation_id:i.generateCorrelationId(),timesStagesWereReached:{},context_name:t}}}t.WebTimingUtil=i;t.CancellableCallback=class{constructor(e){this.canceled=!1,this.callback=e}exec(){this.canceled||this.callback()}cancel(){this.canceled=!0}isCanceled(){return this.canceled}}})),define("metaserver/static/js/filepath/filepath",["require","exports"],(function(e,t){"use strict";function i(e){return e?("/"!==e.charAt(0)&&(e=`/${e}`),"/"===e.charAt(e.length-1)?e.substr(0,e.length-1):e):""}function n(e){if(!e)return{name:"",ext:""};const t=e.split("."),i=e.length>0&&"."===e[0];let n=e.indexOf(".")<0;i&&(n=t.length<=2);const s=t.pop();return s&&!n?{name:t.join("."),ext:s}:{name:e,ext:""}}function s(e){return n(e).ext.toLowerCase()}function r(e){return e.split("/").slice(0,-1).join("/")||"/"}Object.defineProperty(t,"__esModule",{value:!0}),t.joinPathWithFileName=t.parentDirName=t.child_dir=t.parent_dirs=t.parent_dir=t.file_extension_for_logging=t.file_extension=t.split_filename=t.filename_without_extension=t.filename=t.inSubDirectory=t.inSameDirectory=t.paths_are_equal=t.depth=t.normalize=void 0,t.normalize=i,t.depth=function(e){return i(e).split("/").length-1},t.paths_are_equal=function(e,t){return i(e).toLowerCase()===i(t).toLowerCase()},t.inSameDirectory=function(e){if(!e.length)return!1;const t=r(e[0]);return!e.find(e=>r(e)!==t)},t.inSubDirectory=function(e,t){const n=(e=i(e)).split("/"),s=(t=i(t)).split("/");if(s.length<=n.length)return!1;for(let e=0;e<n.length;e++)if(n[e]!==s[e])return!1;return!0},t.filename=function(e,t){const n=(e=i(e)).split("/").pop();return n||(t||"Dropbox")},t.filename_without_extension=function(e){return e?-1===e.indexOf(".")?e:e.split(".").slice(0,-1).join("."):""},t.split_filename=n,t.file_extension=s,t.file_extension_for_logging=function(e){return-1===e.indexOf(".")?"":s(e).toLowerCase()},t.parent_dir=r,t.parent_dirs=function(e){const t=[];let i=r(e);for(;"/"!==i;)t.push(i),i=r(i);return t},t.child_dir=function(e){return e.split("/").pop()||""},t.parentDirName=function(e){const t=e.split("/");return t.length>1?t[t.length-2]:""},t.joinPathWithFileName=function({fqPath:e,fileName:t}){return[e,t].join("/"===e?"":"/")}})),define("metaserver/static/js/uuid/insecure_uuid",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InsecureUUID=void 0;const i=(()=>{let e,t;const i=[];for(t=0,e=t;t<=255;t++,e=t)i.push((e+256).toString(16).substr(1));return i})();t.InsecureUUID=class{static bytesToHex(e){return e.map(e=>i[e]).join("")}static toByte(e){return 255&e}static bytesToUUIDString(e){return[e.slice(0,4),e.slice(4,6),e.slice(6,8),e.slice(8,10),e.slice(10,16)].map(e=>this.bytesToHex(e)).join("-")}static getRandomBytes(){const e=new Array(16);return this.getInsecureRandomValues(e),e.map(e=>this.toByte(e))}static getInsecureRandomValues(e){const t=Math.pow(2,8);for(let i=0;i<e.length;i++)e[i]=Math.floor(Math.random()*t);return e}static v4(){const e=this.getRandomBytes();return e[6]=15&e[6]|64,e[8]=63&e[8]|128,this.bytesToUUIDString(e)}}})),define("metaserver/static/js/clean/visibility_logging",["require","exports","metaserver/static/js/clean/js_client_stopwatch","metaserver/static/js/clean/js_basic_stopwatch"],(function(e,t,i,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.logVisibilityChangeEvents=t.logPaintPerformance=void 0,t.logPaintPerformance=function(e){if(!window.performance||!window.performance.getEntriesByType)return;const t=window.performance.getEntriesByType("paint").map(e=>({type:n.TimingDataType.Trace,name:e.name,endTime:e.startTime}));if(t.length>0){const n=i.JSStopwatch.createDetachedStopwatch("paint",e);n.recordEntries(t),n.logData()}},t.logVisibilityChangeEvents=function(e,t){if(!window.performance||!window.performance.getEntriesByType)return;let s=Number.MAX_VALUE;e.time_to_interactive&&(s=e.time_to_interactive-e.start_time);const r=window.performance.getEntriesByType("mark").filter(e=>e.name.startsWith("VisibilityState.")).map(e=>({visibility:e.name,time:e.startTime})),a={"VisibilityState.visible":0,"VisibilityState.hidden":0};let o;const c=e=>{o&&o.time<s&&(a[o.visibility]=(a[o.visibility]||0)+Math.min(e,s)-o.time)},l=[];r.forEach((e,t)=>{c(e.time),l.push({type:n.TimingDataType.Trace,name:`visibility-change-${t}`,endTime:e.time,annotations:{visibility:e.visibility}}),o=0===t?{visibility:e.visibility,time:0}:e}),c(window.performance.now());for(const e in a)a.hasOwnProperty(e)&&l.push({type:n.TimingDataType.Trace,name:`total-${e}-time`,endTime:a[e]});const d=i.JSStopwatch.createDetachedStopwatch("visibility",t);d.recordEntries(l),d.logData()}})),define("metaserver/static/js/clean/web_module_timing",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.add_module=t.get_module_times=void 0,t.get_module_times=function(){const e=[];for(const t in window.requireContexts){const i=window.requireContexts[t].module_callback_times;for(const t in i)if(i.hasOwnProperty(t)){const n=i[t];if(null!=n.loadTime){const t={load_time:n.loadTime,callback_duration:n.callbackDuration,callback_time:n.callbackTime,name:n.name,url:n.url,parent:n.parent};e.push(t)}}}return e},t.add_module=function(){}})),define("metaserver/static/js/clean/web_timing_logger",["require","exports","tslib","typescript/libraries/shared/apex-metrics/src/index","metaserver/static/js/clean/active_user","metaserver/static/js/metrics/index","metaserver/static/js/devtools/panels/performance/perf_hub_actions","metaserver/static/js/clean/event_load","metaserver/static/js/clean/web_module_timing","metaserver/static/js/clean/window_util","metaserver/static/js/perf_tools/resource_utils","metaserver/static/js/perf_tools/web_timing_logger_types","metaserver/static/js/perf_tools/web_timing_utils","metaserver/static/js/clean/js_client_stopwatch","metaserver/static/js/perf_tools/browser_perf_utils","metaserver/static/js/clean/init_react","metaserver/static/js/perf_tools/cpu_utils","metaserver/static/js/clean/js_basic_stopwatch","metaserver/static/js/modules/constants/request","metaserver/static/js/modules/constants/webtiming","metaserver/static/js/modules/constants/page_load","metaserver/static/js/core/assert","metaserver/static/js/core/browser","metaserver/static/js/core/exception","metaserver/static/js/core/xhr","metaserver/static/js/dropbox/proto/js_init_data/web_timing_logger/web_timing_logger","metaserver/static/js/clean/visibility_logging","metaserver/static/js/user_centric_perf_metrics/metrics_logger"],(function(e,t,i,n,s,r,a,o,c,l,d,u,p,m,_,h,g,f,v,S,w,b,T,y,E,I,N,x){"use strict";var O;Object.defineProperty(t,"__esModule",{value:!0}),t.log_js_modules_fetched_data_required_for_tti=t.log_js_modules_application_code_start=t.waitForTTI=t.mark_time_to_interactive=t.mark_time_to_view=t.set_tti_exclusion_flow=t.time_since_start=t.start_time=t.reset=t.initialize=t.initialize_module=t.time_to_interactive=t.time_to_view=t.delete_timer=t.get_timer=t.perfHubClassName=void 0,o=i.__importStar(o),l=i.__importStar(l),v=i.__importStar(v),S=i.__importStar(S),w=i.__importStar(w),T=i.__importStar(T),y=i.__importStar(y),E=i.__importStar(E),(function(e){e[e.NEW=1]="NEW",e[e.RUNNING=2]="RUNNING",e[e.ABORTED=3]="ABORTED",e[e.CLOSED=4]="CLOSED"})(O||(O={})),t.perfHubClassName="perf-hub-link-container";const C=["navigation_type","referrer","repo_rev","source_type","active_user_id"],A=["tti_flow","tti_exclusion_flow","is_dws2"];function k(){return"hidden"===window.document.visibilityState}const M=[[u.WebTimerEvent.APPLICATION_START,u.WebTimerEvent.MARK_TIME_TO_VIEW,u.WebTimerEvent.FETCHED_DATA_FOR_TTI,u.WebTimerEvent.MARK_TIME_TO_INTERACTIVE],[u.WebTimerEvent.TIME_TO_INTERACTIVE]].reverse();let D=1;const R=["requirejs_start","ensemble_payload_start","body_start"];const P=["craft_fast_prefetch_done","dws_core_externals_loaded","dws_ensemble_init","dws-processChunk-embedded-app-done-1","dws-processChunk-embedded-app-require_config-1","module_init","last_js_const_end","pagelet_render_on_page_embedded-app","pagelet_css_loaded_embedded-app"];class L{constructor(){m.JSStopwatch.create_stopwatch_if_not_exist("web_timing_logger"),this.shouldLogJsModuleTimes=()=>Math.random()<.001}buildBaseParams(e,t,i={}){const n=e.start_time,r=e.subtypes||{};e.tti_flow&&(r.tti_flow=e.tti_flow);const a={log_source:t.name,subtypes:JSON.stringify(r),correlation_id:e.correlation_id};let o,c;e.extra_columns&&Object.keys(e.extra_columns).forEach(t=>{const i=e.extra_columns[t];i&&(a[t]=i)}),Object.keys(i).forEach(e=>{const t=i[e];t&&(a[e]=t)}),v.IS_HTTP2&&(a.is_spdy=!0),e.is_pagelet&&(a.is_pagelet=!0),e.is_dws&&(a.is_dws=!0),e.is_early_ensemble&&(a.is_early_ensemble=!0),a.delayed_tti_for_css=e.delayed_tti_for_css,""!==e.tti_exclusion_flow&&(a.tti_exclusion_flow=e.tti_exclusion_flow),o=e.log_time_to_view&&null!=e.time_to_view?e.time_to_view-n:null,c=e.log_time_to_interactive&&null!=e.time_to_interactive?e.time_to_interactive-n:null;const l={navigation_type:this.get_navigation_type(),server_request_start_time:v.REQUEST_START_TIME,extra_columns:JSON.stringify(a),subtypes:JSON.stringify(r),source_type:e.source_type,page_load_time:e.end_time-e.start_time,repo_rev:w.REPO_REV};return this.shouldLogJsModuleTimes()&&Z(l),e.log_time_to_view&&(l.time_to_view=o),e.log_time_to_interactive&&(l.time_to_interactive=c),l.url=T.get_href(),0===l.url.indexOf("/dws2/")&&(l.url=l.url.substring("/dws2/".length-1)),l.active_user_id=(0,s.getActiveUserId)(),l.referrer=document.referrer,l.request_id=e.request_id||v.REQUEST_ID,l.request_tracing_enabled=v.REQUEST_TRACING_ENABLED,window.ensemble&&window.ensemble.viewer&&(l.dws_page_name=window.ensemble.getPageName()),window.EDISON_PAGE_NAME&&(l.edison_page_name=window.EDISON_PAGE_NAME),l}get_navigation_type(){return u.NavigationType.getFromNavigation(window.performance.navigation)}log(e,i,n=!1){const s=m.JSStopwatch.startSpan("wtl_endpoint",{stopwatchName:"web_timing_logger"});m.JSStopwatch.addSpanAnnotation("wtl_endpoint","navigation_type",i.navigation_type,{stopwatchName:"web_timing_logger",spanId:s});const r=E.sendXhr("/alternate_wtl",i);r.onreadystatechange=e=>{if(r.readyState===XMLHttpRequest.DONE&&200===r.status){m.JSStopwatch.endSpan("wtl_endpoint",{stopwatchName:"web_timing_logger",spanId:s});const e=document.getElementsByClassName(t.perfHubClassName);if(n&&e.length){const e=JSON.parse(r.responseText);e.status&&a.PerfHubActions.add_web_timing_details(e)}}}}}class j extends L{constructor(){super()}shouldLog(e){return e.initialized&&!e.have_logged_web_timing&&void 0!==e.end_time&&(!e.log_time_to_view||null!=e.time_to_view)&&(!e.log_time_to_interactive||null!=e.time_to_interactive)}logTiming(e,t){e.have_logged_web_timing=!0;const i=this.buildBaseParams(e,t),n=z(e,i);return this.log(e,i,!1),n}get_navigation_type(){return"ajax"}}class U extends L{constructor(){super()}shouldLog(e){if(!e.initialized||e.have_logged_web_timing)return!1;const t=window.performance.timing,i=e.start_time,n=e.end_time;return!(!i||!n)&&(!(e.log_time_to_view&&!(e.ttv_at_dom_interactive&&t.domInteractive||null!=e.time_to_view))&&!(e.log_time_to_interactive&&!(e.tti_at_dom_interactive&&t.domInteractive||null!=e.time_to_interactive)))}logTiming(e,t){const i=window.performance,s=i.timing,a=(0,g.getAllGlobalExecutionPerfMeasurements)();let o=e.timesStagesWereReached["dws_embedded-app_require_config_callback"];void 0===o?o=e.timesStagesWereReached.application_code_start:e.timesStagesWereReached.hasOwnProperty("application_code_start")&&(o=Math.min(o,e.timesStagesWereReached.application_code_start)),m.JSStopwatch.startSpan("process_nav_timing",{stopwatchName:"web_timing_logger"});const c=this.buildBaseParams(e,t,{}),l=z(e,c),p=window.ensemble&&window.ensemble.getJSStopwatchData?window.ensemble.getJSStopwatchData():{},f="function"==typeof i.getEntriesByType?(0,d.summarizePerformanceResourceTimings)(i.getEntriesByType("resource"),o):{pre:{},total:{}};c.browser_time=(s.redirectStart||s.fetchStart)-e.start_time,c.redirect_time=s.fetchStart-e.start_time,c.dns_time=s.domainLookupEnd-e.start_time,c.tcp_connect_time=(s.secureConnectionStart||s.requestStart)-e.start_time,c.ssl_connect_time=s.requestStart-e.start_time,c.time_to_first_byte=s.responseStart-e.start_time,c.time_to_last_byte=s.responseEnd-e.start_time,c.dom_load_time=s.domContentLoadedEventEnd-e.start_time,c.idle_cpu_time=e.timing_results?Math.round(e.timing_results.idleCPUTime):void 0,c.total_tracked_cpu_time=e.timing_results?Math.round(e.timing_results.totalTrackedCPUTime):void 0,c.untracked_time_after_first_byte=e.timing_results&&null!=e.timing_results.untrackedTimeAfterFirstByte?Math.round(e.timing_results.untrackedTimeAfterFirstByte):void 0,(function(e,t){for(const i in e)e.hasOwnProperty(i)&&(t[`resource_${i}_count`]=e[i].count,t[`resource_${i}_avg_time`]=e[i].total_time/e[i].count||1,void 0!==e[i].total_size&&(t[`resource_${i}_total_size`]=e[i].total_size),void 0!==e[i].transfer_size&&(t[`resource_${i}_transfer_size`]=e[i].transfer_size))})(f.total,c),(function(e,t){let i;for(i in e)if(e.hasOwnProperty(i)){const n=e[i];for(const e in n)if(n.hasOwnProperty(e)){const s=n[e].transfer_size,r=n[e].total_size,a=n[e].count,o=n[e].total_time;if(t.recordTrace(`${i}_${e}_count`,a),t.recordTrace(`${i}_${e}_total_time`,o),void 0!==s&&void 0!==r&&r>0){const n=s/r;t.recordTrace(`${i}_${e}_transferred_size`,s),t.recordTrace(`${i}_${e}_total_size`,r),t.recordTrace(`${i}_percent_${e}_transferred`,100*n)}t.recordTrace(`${i}_last_${e}_transfer_end`,n[e].last_transfer_end)}}t.logData()})(f,m.JSStopwatch.createDetachedStopwatch("resources_percent_transferred",l)),m.JSStopwatch.addSpanAnnotation("process_nav_timing","logged_resources","1",{stopwatchName:"web_timing_logger"}),this.shouldLogJsModuleTimes()&&Z(c),m.JSStopwatch.addSpanAnnotation("process_nav_timing","logged_modules","1",{stopwatchName:"web_timing_logger"}),m.JSStopwatch.endSpan("process_nav_timing",{stopwatchName:"web_timing_logger"}),e.is_pagelet&&Object.getOwnPropertyNames(p).length>0&&(function(e,t,i){const n=(function(e,t){const i=(0,g.listAnnotatedExecutionPerfMeasurementsForEnsemble)(t),n=m.JSStopwatch.createDetachedStopwatch("ensemble",e),s=i.map(({measurement:e,annotations:t})=>({name:e.name,startTime:e.startTime,endTime:e.startTime+e.totalTime,annotations:t}));return Y(n,s),n})(i,t);let s=void 0,r=void 0;for(const i in t)t.hasOwnProperty(i)&&(X.includes(i)&&(e.timesStagesWereReached[i]=t[i].start),["dws_embedded-app_require_config_callback"].includes(i)&&(s=s?Math.min(s,t[i].end):t[i].end),Q.test(i)&&(r=r?Math.max(r,t[i].end):t[i].end));r&&n.recordTrace("last_js_const_end",r);s&&n.recordTrace("module_init",s)})(e,p,l),(0,_.logBrowserPerfData)(l),(function(e,t,i){(0,g.logCumulativeExecutionTimes)(e,(0,g.cumulativeExecutionTimesBefore)(t,i))})(l,e.timesStagesWereReached,a),this.get_navigation_type()===u.NavigationType.NAVIGATE&&((function(e){const t=(0,h.getReactInitData)();Y(m.JSStopwatch.createDetachedStopwatch("init_react",e),t)})(l),(0,d.logResourcesData)(l)),m.JSStopwatch.log_stored_results();const v=(function(e,t){const i={is_dws:String(e.is_dws),source_type:String(e.source_type),rollup_format:e.rollup_format};let n="";return e.subtypes.amp_tti_flow?n=e.subtypes.amp_tti_flow:t.dws_page_name?n=`dws_page_name:${t.dws_page_name}`:t.edison_page_name&&(n=`edison_page_name:${t.edison_page_name}`),""!==n&&(i.product=n),t.navigation_type&&(i.navigation_type=t.navigation_type),i})(e,c),S=(0,r.getMetricsReporter)().child(v),w=(function(e,t){return t.navigation_type===u.NavigationType.NAVIGATE||"ajax"===t.navigation_type})(0,c),b=(0,r.getUnloadMetricsReporter)().child(v);return(0,x.logUserCentricPerfMetrics)(b,w),w&&((function(e,t){if(e.time_to_interactive){t.createStats({ns:"web_timing",name:"temp/time-to-interactive"}).recordDuration(e.time_to_interactive,n.TimeUnit.MILLISECONDS)}})(c,S),(function(e,t){let i;for(i in e)if(e.hasOwnProperty(i)){const s=e[i];for(const e in s)if(s.hasOwnProperty(e)){const{transfer_size:r,total_size:a,count:o,total_time:c,last_transfer_end:l}=s[e];t.createStats({ns:"web_timing",name:`temp/resources/${i}/${e}/count`}).record(o),t.createStats({ns:"web_timing",name:`temp/resources/${i}/${e}/total-time`}).recordDuration(c,n.TimeUnit.MILLISECONDS),t.createStats({ns:"web_timing",name:`temp/resources/${i}/${e}/last-transfer-end`}).recordDuration(l,n.TimeUnit.MILLISECONDS),void 0!==r&&void 0!==a&&a>0&&(t.createStats({ns:"web_timing",name:`temp/resources/${i}/${e}/transferred-size`}).record(r),t.createStats({ns:"web_timing",name:`temp/resources/${i}/${e}/total-size`}).record(a))}}})(f,S),e.is_pagelet&&Object.getOwnPropertyNames(p).length>0&&(function(e,t,i){const s=(0,g.listAnnotatedExecutionPerfMeasurementsForEnsemble)(t);let r=void 0,a=void 0;s.forEach(({measurement:t})=>{const s=t.startTime+t.totalTime;-1!==P.indexOf(t.name)&&i.createStats({ns:"web_timing",name:`temp/ensemble-timing/${t.name}`}).recordDuration(s,n.TimeUnit.MILLISECONDS),X.includes(t.name)&&(e.timesStagesWereReached[t.name]=t.startTime),["dws_embedded-app_require_config_callback"].includes(t.name)&&(r=r?Math.min(r,s):s),Q.test(t.name)&&(a=a?Math.max(a,s):s)}),void 0!==a&&i.createStats({ns:"web_timing",name:"temp/last-js-const-end"}).recordDuration(a,n.TimeUnit.MILLISECONDS),void 0!==r&&i.createStats({ns:"web_timing",name:"temp/module-init"}).recordDuration(r,n.TimeUnit.MILLISECONDS)})(e,p,S),(function(e,t){e.getEntriesByType("mark").filter(e=>R.indexOf(e.name)>-1).forEach(e=>{t.createStats({ns:"web_timing",name:`temp/browser-perf/marks/${e.name}`}).recordDuration(e.startTime,n.TimeUnit.MILLISECONDS)})})(i,S),(function(e,t){const[i=null]=e.getEntriesByType("navigation");i&&([["temp/browser-perf/navigation/unload-event-start",i.unloadEventStart],["temp/browser-perf/navigation/unload-event-end",i.unloadEventEnd],["temp/browser-perf/navigation/dom-interactive",i.domInteractive],["temp/browser-perf/navigation/dom-content-loaded-event-start",i.domContentLoadedEventStart],["temp/browser-perf/navigation/dom-content-loaded-event-end",i.domContentLoadedEventEnd],["temp/browser-perf/navigation/dom-complete",i.domComplete],["temp/browser-perf/navigation/load-event-start",i.loadEventStart],["temp/browser-perf/navigation/load-event-end",i.loadEventEnd],["temp/browser-perf/navigation/redirect-count",i.redirectCount],["temp/browser-perf/navigation/worker-start",i.workerStart],["temp/browser-perf/navigation/redirect-start",i.redirectStart],["temp/browser-perf/navigation/redirect-end",i.redirectEnd],["temp/browser-perf/navigation/fetch-start",i.fetchStart],["temp/browser-perf/navigation/domain-lookup-start",i.domainLookupStart],["temp/browser-perf/navigation/domain-lookup-end",i.domainLookupEnd],["temp/browser-perf/navigation/connect-start",i.connectStart],["temp/browser-perf/navigation/connect-end",i.connectEnd],["temp/browser-perf/navigation/secure-connect-start",i.secureConnectionStart],["temp/browser-perf/navigation/request-start",i.requestStart],["temp/browser-perf/navigation/response-start",i.responseStart],["temp/browser-perf/navigation/response-end",i.responseEnd],["temp/browser-perf/navigation/transfer-size",i.transferSize]].forEach(([e,i])=>{if("number"==typeof i){t.createStats({ns:"web_timing",name:e}).recordDuration(i,n.TimeUnit.MILLISECONDS)}}),[["temp/browser-perf/navigation/encoded-body-size",i.encodedBodySize],["temp/browser-perf/navigation/decoded-body-size",i.decodedBodySize]].forEach(([e,i])=>{if("number"==typeof i){t.createStats({ns:"web_timing",name:e}).record(i)}}))})(i,S)),(0,N.logPaintPerformance)(l),(0,N.logVisibilityChangeEvents)(e,l),e.have_logged_web_timing=!0,this.log(e,c,!0),l}log(e,t,i=!1){super.log(e,t,i)}}class q{constructor(e,t,i,n){this.childSpans=[],this.spanName=e,this.startTime=void 0!==i?i:p.WebTimingUtil.getNow(),this.originTs=t,this.startTimeOffsetMS=this.startTime-t,this.endCallback=n}startSpan(e){const t=new q(e,this.originTs);return this.childSpans.push(t),t}markSpan(e,t){const i=new q(e,this.originTs,this.startTime);this.childSpans.push(i),i.endSpan(t)}endSpan(e){this.endTime=void 0!==e?e:p.WebTimingUtil.getNow(),this.childSpans.forEach(e=>{e.hasEnded()||e.endSpan(this.endTime)}),this.endCallback&&this.endCallback(this)}getEndTimeOffsetMS(){return void 0!==this.endTime?this.endTime-this.originTs:void 0}hasEnded(){return void 0!==this.endTime}}class B{constructor(e,t,i,n=!1){this.timerState=O.RUNNING,this.loggedEvents=0,this.activeSpans=[],this.endedSpans=[],this.context=e,this.timingStopwatch=t,this.userStopwatch=i,this.id=D++,this.strictAssert=n}startSpan(e){const t=new q(e,this.context.start_time,void 0,e=>{this.endSpan(e)});return this.activeSpans.push(t),t}markSpan(e,t={}){if(this.userStopwatch){const i=void 0===t.startTime?0:t.startTime,n=this.timeSinceStart(t.endTime),s=this.userStopwatch.startSpan(e,{startTime:i});this.userStopwatch.endSpan(e,{spanId:s,endTime:n})}else{const i=new q(e,this.context.start_time,t.startTime);i.endSpan(t.endTime),this.endedSpans.push(i)}}endSpan(e){const t=this.activeSpans.indexOf(e);t>=0&&(delete this.activeSpans[t],this.userStopwatch?this.recordSpan(e):this.endedSpans.push(e))}recordSpan(e){const t=this.userStopwatch.startSpan(e.spanName,{startTime:e.startTimeOffsetMS});e.childSpans.forEach(e=>{this.recordSpan(e)}),this.userStopwatch.endSpan(e.spanName,{spanId:t,endTime:e.getEndTimeOffsetMS()})}getContextName(){return this.context.context_name}applicationStart(){this.logEvent(u.WebTimerEvent.APPLICATION_START)}fetchedDataRequiredForTTI(){this.logEvent(u.WebTimerEvent.FETCHED_DATA_FOR_TTI)}startTime(){return this.context.start_time}timeSinceStart(e){return(e||p.WebTimingUtil.getNow())-this.context.start_time}timeToView(){return this.context.time_to_view}timeToInteractive(){return this.context.time_to_interactive}reportTTIAfterPaint(){const e=new p.CancellableCallback(()=>{this.reportTTI()});return window.requestAnimationFrame(()=>{window.requestAnimationFrame(()=>{e.exec()})}),e}setExtraColumns(e){this.context.extra_columns=e}excludeFromTTI(e){""!==this.context.tti_exclusion_flow&&(this.context.tti_exclusion_flow=this.context.tti_exclusion_flow+","),this.context.tti_exclusion_flow=this.context.tti_exclusion_flow+e}logEvent(e,t){this.logEventInternal(e,!0,t)}logSilentEvent(e,t){this.logEventInternal(e,!1,t)}logEventInternal(e,t,i){this.loggedEvents|=e.flag,e.ordered&&this.validateEventOrder(e);const n=this.timeSinceStart(i);this.context.timesStagesWereReached[e.name]=n,this.timingStopwatch.recordTrace(e.name,n),console.timeStamp&&console.timeStamp(e.timestampPrefix),window.performance.mark&&window.performance.mark(e.name),t&&e.triggersLogging&&this.logIfReady(e)}validateEventOrder(e){let t=0;for(const i of M){if(i.includes(e))break;for(const e of i)t|=e.flag}const i=t&this.loggedEvents;if(i>0){const t=u.WebTimerEvent.allEvents.filter(e=>(e.flag&i)>0).map(e=>e.name);this.reportSwMisuse(`Received ${e.name} after [${t.join(",")}]`)}}logIfReady(e){if(this.logger.shouldLog(this.context)){this.addEventBasedTiming();const t=this.logger.logTiming(this.context,e);G(this.timingStopwatch,t),G(this.userStopwatch,t),this.timingStopwatch.logData(),this.userStopwatch.logData(),this.timerState=O.CLOSED}}addEventBasedTiming(){const e=window.performance.timing;this.context.ttv_at_dom_interactive&&(this.context.is_pagelet&&window.ensemble?this.context.time_to_view=window.ensemble.getEmbeddedAppDOMInteractive():this.context.time_to_view=e.domInteractive,this.logSilentEvent(u.WebTimerEvent.MARK_TIME_TO_VIEW,this.context.time_to_view)),this.context.tti_at_dom_interactive&&(this.context.time_to_interactive=e.domInteractive,this.logSilentEvent(u.WebTimerEvent.MARK_TIME_TO_INTERACTIVE,this.context.time_to_interactive),this.logSilentEvent(u.WebTimerEvent.TIME_TO_INTERACTIVE,this.context.time_to_interactive))}reportSwMisuse(e){e=`WebTimer: ${e}`,this.strictAssert?(0,b.assert)(!1,e):y.reportStack(e,{severity:y.SEVERITY.NONCRITICAL,tags:["web_timing_logger"]})}}class F extends B{constructor(e){super(e,m.JSStopwatch.createDetachedStopwatch("maestro_tracing",{correlation_id:e.correlation_id}),m.JSStopwatch.createDetachedStopwatch("user_tracing",{correlation_id:e.correlation_id}),!1),this.logger=new j}initialize(e){this.context.initialized||(this.context.initialized=!0,this.context.log_time_to_view=!!e.requireTTV,this.context.log_time_to_interactive=e.requireTTI,this.context.tti_flow=e.url,this.timingStopwatch.url=this.context.tti_flow,this.userStopwatch.url=this.context.tti_flow)}start(){this.isUsable()&&this.timerState===O.NEW&&(this.context.start_time=p.WebTimingUtil.getNow(),this.timerState=O.RUNNING)}restart(){this.TTICallback&&(this.TTICallback.cancel(),this.TTICallback=void 0),this.loggedEvents=0,this.context.have_logged_web_timing=!1,this.context.correlation_id=p.WebTimingUtil.generateCorrelationId(),this.context.start_time=p.WebTimingUtil.getNow(),this.context.end_time=void 0,this.context.time_to_view=null,this.context.time_to_interactive=null,this.timerState=O.RUNNING,m.JSStopwatch.deleteStopwatch(this.timingStopwatch),this.timingStopwatch=m.JSStopwatch.createDetachedStopwatch("maestro_tracing",{request_id:this.context.request_id,url:this.context.tti_flow,correlation_id:this.context.correlation_id}),m.JSStopwatch.deleteStopwatch(this.userStopwatch),this.userStopwatch=m.JSStopwatch.createDetachedStopwatch("user_tracing",{request_id:this.context.request_id,url:this.context.tti_flow,correlation_id:this.context.correlation_id})}abort(){this.timerState!==O.CLOSED&&(this.timerState=O.ABORTED)}markTimeToView(){this.isUsable()&&(null==this.context.time_to_view&&(this.context.time_to_view=p.WebTimingUtil.getNow()),this.logEvent(u.WebTimerEvent.MARK_TIME_TO_VIEW))}markTimeToInteractive(){this.isUsable()&&(this.logEvent(u.WebTimerEvent.MARK_TIME_TO_INTERACTIVE),k()?this.reportTTI():this.TTICallback=this.reportTTIAfterPaint())}reportTTI(){if(null!=this.context.time_to_interactive)return;this.context.time_to_interactive=p.WebTimingUtil.getNow(),this.logEvent(u.WebTimerEvent.TIME_TO_INTERACTIVE),new Promise((t,i)=>{e(["metaserver/static/js/logging/telemetry"],t,i)}).then(i.__importStar).then(({getGlobalTelemetrySingleton:e})=>{e().sendOnce()});const t=this.timeSinceStart(this.context.time_to_interactive);ee(this.id,t,!0)}end(e){this.isUsable()&&(void 0===this.context.end_time&&(this.context.end_time=p.WebTimingUtil.getNow()),this.context.request_id=e,this.timingStopwatch.request_id=e,this.userStopwatch.request_id=e,this.logEvent(u.WebTimerEvent.LOAD_END))}waitForTTI(e){return new Promise((t,i)=>{if(null!=this.context.time_to_interactive)return void t();let n;const s=e=>{window.removeEventListener("TTI."+this.id,s),clearTimeout(n),t()};window.addEventListener("TTI."+this.id,s),e&&void 0!==e.timeoutMS&&(n=setTimeout(s,e.timeoutMS))})}isUsable(){return this.timerState===O.NEW||this.timerState===O.RUNNING}}class W extends B{constructor(e){super(e,m.JSStopwatch.createDetachedStopwatch("maestro_tracing",{correlation_id:e.correlation_id}),m.JSStopwatch.createDetachedStopwatch("user_tracing",{correlation_id:e.correlation_id}),!1),this.logger=new U}initialize(e){if(!this.context.initialized){this.context.log_time_to_view=!!e.requireTTV,this.context.log_time_to_interactive=e.requireTTI,this.context.is_pagelet=!!e.is_pagelet,this.context.is_dws=!!e.is_dws,this.context.is_dws2=!!e.is_dws2,this.context.is_early_ensemble=!!e.is_early_ensemble,this.context.ttv_at_dom_interactive=!!e.ttv_at_dom_interactive,this.context.tti_at_dom_interactive=!!e.tti_at_dom_interactive,this.context.source_type=null!=e.source_type?e.source_type:"web",this.context.subtypes=null!=e.subtypes?e.subtypes:{},this.context.tti_exclusion_flow=null!=e.tti_exclusion_flow?e.tti_exclusion_flow:"",this.context.have_logged_web_timing=!1,this.context.delayed_tti_for_css=!1,this.context.rollup_format=e.rollup_format||"off",this.context.initialized=!0,e.url&&(this.context.tti_flow=e.url,this.timingStopwatch.url=e.url,this.userStopwatch.url=e.url),this.context.subtypes.tti_flow&&(this.context.tti_flow=this.context.subtypes.tti_flow);let t=0;if(S.LOG_TIMING_DELAY&&(t=600),m.JSStopwatch.create_stopwatch_if_not_exist("web_timing_logger"),o.window_load(()=>{setTimeout(()=>this.end(),t)}),l.onPageRestore(e=>{const t=m.JSStopwatch.createDetachedStopwatch("browser_perf",{correlation_id:this.context.correlation_id});t.recordTrace("page_restore"),t.logData()}),!this.context.ttv_at_dom_interactive&&window._timingData&&(null!=window._timingData.ttv&&(this.context.time_to_view=window._timingData.ttv.getTime(),this.logEvent(u.WebTimerEvent.MARK_TIME_TO_VIEW,this.context.time_to_view)),null!=window._timingData.tti)){this.context.time_to_interactive=window._timingData.tti.getTime(),this.logEvent(u.WebTimerEvent.TIME_TO_INTERACTIVE,this.context.time_to_interactive),ee(void 0,this.timeSinceStart(this.context.time_to_interactive))}}}start(){this.isUsable()&&this.timerState===O.NEW&&(this.timerState=O.RUNNING)}restart(){this.TTICallback&&(this.TTICallback.cancel(),this.TTICallback=void 0),this.loggedEvents=0,this.context.correlation_id=p.WebTimingUtil.generateCorrelationId(),this.context.end_time=void 0,this.context.time_to_view=null,this.context.time_to_interactive=null,this.timerState=O.RUNNING,this.timingStopwatch=m.JSStopwatch.createDetachedStopwatch("maestro_tracing",{correlation_id:this.context.correlation_id}),this.userStopwatch=m.JSStopwatch.createDetachedStopwatch("user_tracing",{correlation_id:this.context.correlation_id})}abort(){this.timerState!==O.CLOSED&&(this.timerState=O.ABORTED)}markTimeToView(){this.isUsable()&&(null!=this.context.time_to_view||this.context.ttv_at_dom_interactive||(window._timingData&&null!=window._timingData.ttv?this.context.time_to_view=window._timingData.ttv.getTime():this.context.time_to_view=p.WebTimingUtil.getNow(),this.logEvent(u.WebTimerEvent.MARK_TIME_TO_VIEW,this.context.time_to_view)))}markTimeToInteractive(){if(window.ensemble&&window.ensemble.waitingForCss)return this.context.delayed_tti_for_css=!0,void(window.ensemble.mark_tti_callback=()=>{this.markTimeToInteractive()});null!=this.context.time_to_interactive||this.context.tti_at_dom_interactive||(this.logEvent(u.WebTimerEvent.MARK_TIME_TO_INTERACTIVE),k()?this.reportTTI():this.TTICallback=this.reportTTIAfterPaint())}reportTTI(){if(null==this.context.time_to_interactive)if(window._timingData&&null!=window._timingData.tti?this.context.time_to_interactive=window._timingData.tti.getTime():this.context.time_to_interactive=p.WebTimingUtil.getNow(),console.timeStamp&&console.timeStamp("TTI"),window.ensemble&&window.ensemble.snapshotTimingProfile&&(this.context.timing_results=window.ensemble.snapshotTimingProfile()||null),window.RUNNING_IN_EDISON)new Promise((t,i)=>{e(["metaserver/static/js/edison/edison"],t,i)}).then(i.__importStar).then(({Edison:e})=>{const t=e.getPrefetchCounts(),i={};for(const e of Object.keys(t))i[e]=t[e].toString();this.context.subtypes=Object.assign(Object.assign({},i),this.context.subtypes),this.logEvent(u.WebTimerEvent.TIME_TO_INTERACTIVE,this.context.time_to_interactive),ee(void 0,this.timeSinceStart(this.context.time_to_interactive))});else{this.logEvent(u.WebTimerEvent.TIME_TO_INTERACTIVE,this.context.time_to_interactive),ee(void 0,this.timeSinceStart(this.context.time_to_interactive))}}end(e){this.isUsable()&&void 0===this.context.end_time&&(this.context.end_time=p.WebTimingUtil.getNow(),this.logEvent(u.WebTimerEvent.LOAD_END),this.context.tti_at_dom_interactive&&ee())}waitForTTI(e){return new Promise((t,i)=>{if(window.ensemble){if(window.ensemble.ttiMarked)return void t()}else if(null!=this.context.time_to_interactive)return void t();let n;const s=e=>{window.removeEventListener("TTI",s),clearTimeout(n),t()};window.addEventListener("TTI",s),e&&void 0!==e.timeoutMS&&(n=setTimeout(s,e.timeoutMS))})}isUsable(){return this.timerState===O.NEW||this.timerState===O.RUNNING}}const V={};let J;function z(e,t){const i={};for(const e of C){const n=t[e];n&&(i[e]=String(n))}const n=e;for(const e of A){const t=n[e];t&&(i[e]=String(t))}return{correlation_id:e.correlation_id,request_id:t.request_id,annotations:i}}function G(e,t){if(t.annotations)for(const i in t.annotations)if(t.annotations.hasOwnProperty(i)){const n=t.annotations[i];n&&e.addAnnotation(i,String(n))}t.correlation_id&&e.addAnnotation(m.ReservedAnnotationKey.CORRELATION_ID.id,t.correlation_id),t.request_id&&e.addAnnotation(m.ReservedAnnotationKey.REQUEST_ID.id,t.request_id),t.url&&e.addAnnotation(m.ReservedAnnotationKey.URL.id,t.url)}function $(e){return e?(function(e){const t=e;return V[t]||(V[t]=new F(p.WebTimingUtil.newContext(!0,e))),V[t]})(e):(J||H(),J)}function K(e={}){$().initialize({requireTTV:!!e.log_time_to_view,requireTTI:!!e.log_time_to_interactive,is_pagelet:e.is_pagelet,is_dws:e.is_dws,is_dws2:e.is_dws2,is_early_ensemble:e.is_early_ensemble,ttv_at_dom_interactive:e.ttv_at_dom_interactive,tti_at_dom_interactive:e.tti_at_dom_interactive,source_type:e.source_type,subtypes:e.subtypes,tti_exclusion_flow:e.tti_exclusion_flow,url:e.url,rollup_format:e.rollup_format})}function H(){J=new W(p.WebTimingUtil.newContext(!1,"default_timer"))}function Y(e,t){e.recordEntries(t.map(e=>({type:0!==e.startTime?f.TimingDataType.Span:f.TimingDataType.Trace,name:e.name,startTime:e.startTime,endTime:e.endTime,annotations:e.annotations}))),e.logData()}H(),t.get_timer=$,t.delete_timer=function(e){delete V[e]},t.time_to_view=function(){return $().timeToView()},t.time_to_interactive=function(){return $().timeToInteractive()},t.initialize_module=K,t.initialize=function(e,t){const i=t.dwsOpts;let n;switch(t.sourceType){case I.web_timing_logger.WebTimingLoggerServerContext.SourceType.UNKNOWN:n="unknown";break;case I.web_timing_logger.WebTimingLoggerServerContext.SourceType.MOBILE_WEB:n="mobile";break;case I.web_timing_logger.WebTimingLoggerServerContext.SourceType.DESKTOP_WEB:n="web"}const s={is_pagelet:t.isDws,is_dws:t.isDws,is_dws2:null!=i&&i.isDws2,is_early_ensemble:null!=i&&i.isEarlyEnsemble,subtypes:Object.assign(Object.assign({},t.subtypes),{js_preloading:null!=i&&i.jsPreloading?"true":"false"}),source_type:n,url:t.url};K(Object.assign(Object.assign({},s),e))},t.reset=H,t.start_time=function(){return $().startTime()},t.time_since_start=function(){return $().timeSinceStart()},t.set_tti_exclusion_flow=function(e){$().excludeFromTTI(e)};const X=["dws_ensemble_init","dws_embedded-app_require_config_callback","dws-processChunk-embedded-app-require_config-1"],Q=new RegExp("dws-processChunk-embedded-app-const_module.*");function Z(e){const t=(0,c.get_module_times)(),i=[];for(const e of t){const t=e.url;if(void 0===t&&e.name&&-1===e.name.indexOf("!")){y.reportStack(`Module ${e.name} with invalid map object fetched by requirejs`,{severity:y.SEVERITY.NONCRITICAL,tags:["log_js_module_timing"]});continue}let n=[];if(t&&(n=window.performance.getEntriesByName(t,"resource")),0!==n.length)e.start_time=n[0].startTime+n[0].duration;else{if(!("callback_duration"in e))continue;e.start_time=0}i.push(e)}e.js_module_times=JSON.stringify(i)}function ee(e,t,i=!1){if(window.ensemble&&window.ensemble.markTTI)window.ensemble.markTTI();else{const t=new CustomEvent(void 0!==e?`TTI.${e}`:"TTI",{bubbles:!0,cancelable:!0});window.dispatchEvent(t)}const n=new CustomEvent("time_to_interactive",{detail:{value:t,isAjax:i},bubbles:!0,cancelable:!0});window.dispatchEvent(n)}t.mark_time_to_view=function(){$().markTimeToView()},t.mark_time_to_interactive=function(e={}){const t=$();t.setExtraColumns(e),t.markTimeToInteractive()},t.waitForTTI=function(e){return $().waitForTTI(e)},t.log_js_modules_application_code_start=function(){$().applicationStart()},t.log_js_modules_fetched_data_required_for_tti=function(){$().fetchedDataRequiredForTTI()}})),define("metaserver/static/js/clean/window_util",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onPageRestore=t.onBeforeUnload=void 0,t.onBeforeUnload=function(e){window.addEventListener("beforeunload",(function t(){e(),window.removeEventListener("beforeunload",t)}))},t.onPageRestore=function(e){window.addEventListener("pageshow",(function t(i){i.persisted&&(e(),window.removeEventListener("pageshow",t))}))}})),define("metaserver/static/js/clean/js_basic_stopwatch",["require","exports","metaserver/static/js/core/assert","metaserver/static/js/core/exception"],(function(e,t,i,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createStopwatch=t.NoopStopwatchInstance=t.JSBasicStopwatchImpl=t.TimingDataType=void 0;const s=!(!window.performance||!window.performance.now);let r=0;var a;(function(e){e[e.Span=1]="Span",e[e.AsyncSpan=2]="AsyncSpan",e[e.Trace=3]="Trace"})(a=t.TimingDataType||(t.TimingDataType={}));class o{constructor(e,t,i,n=!1,s){this.name=e,this.strictAssert=t,this.activeSpans={},this.aggregateSpans={},this._annotations=Object.assign({},s),this.spanStack=[],this.stopwatchTags=i||[],this.detached=n}reset(){this.activeSpans={},this.spanStack=[],this.aggregateSpans={},this._annotations={}}get annotations(){return this._annotations}addAnnotation(e,t){this._annotations[e]=t}removeAnnotation(e){delete this._annotations[e]}popResolvedSpans(){if(this.detached)return{};{const e=this.aggregateSpans;return this.aggregateSpans={},e}}peekResolvedSpans(){return this.detached?{}:this.aggregateSpans}static newSpanID(){const e=String(r);return r++,e}static resolveTime(e){return void 0===e&&(e=window.performance.now()),Math.round(e)}_resolveParent(e){if(e.type!==a.Span)return void(e.parent="");const t=this.spanStack[this.spanStack.length-1];if(t)if(t!==e.name)this._report_sw_misuse(`Closing ${t} while the latest open span is ${e.name}.\n        You are either mixing sync and async spans or closing sync spans out of order.`);else{this.spanStack.pop();let t="";for(const e of this.spanStack)t+=`${e}#`;e.parent=t}else this._report_sw_misuse(`${e.name} isn't a synchronous span and has to be started with "async:true".`)}recordTrace(e,t={}){const i=o.resolveTime(t.traceTime),n=o.newSpanID(),s={name:e,span_id:n,start_time:0,end_time:i,annotations:Object.assign({},t.annotations),type:a.Trace,parent:""};return this.recordSpan(this.stopwatchTags,s),n}start(e,t={}){e||this._report_sw_misuse("Reporting a span without a name");const i=o.resolveTime(t.startTime);t.async||this.spanStack.push(e);const n=o.newSpanID(),s={name:e,span_id:n,start_time:i||0,annotations:Object.assign({},t.annotations),type:t.async?a.AsyncSpan:a.Span};return e in this.activeSpans||(this.activeSpans[e]=[]),this.activeSpans[e].push(s),n}end(e,t={}){const i=this.findTimerDataIndex(e,t.spanId);if(-1===i)return;const n=this.activeSpans[e],s=n[i];n.splice(i,1),this._resolveParent(s);const r=o.resolveTime(t.endTime);if(!(r<s.start_time))return s.end_time=r,this.recordSpan(this.stopwatchTags,s),s.span_id;this._report_sw_misuse(`span ${e} has set an endTime earlier than start_time`)}addSpanAnnotation(e,t,i,n){const s=this.findTimerDataIndex(e,n);-1!==s&&(this.activeSpans[e][s].annotations[t]=i)}attach(){this.detached=!1}findTimerDataIndex(e,t){if(!(e in this.activeSpans)||0===this.activeSpans[e].length)return this._report_sw_misuse(`tried to find ${e} but that span doesn't exist`),-1;let i=-1;const n=this.activeSpans[e];if(void 0===t)i=0;else for(let e=0;e<n.length;e++)if(n[e].span_id===t){i=e;break}return-1===i&&this._report_sw_misuse(`tried to find ${e} with id ${t} but that span doesn't exist`),i}_report_sw_misuse(e){e=`JSBasicStopwatch ${this.name}: ${e}`,this.strictAssert?(0,i.assert)(!1,e):(0,n.reportStack)(e,{severity:n.SEVERITY.NONCRITICAL,tags:["log_js_stopwatch"]})}recordSpan(e,t){const i=`${t.parent}${t.name}`;i in this.aggregateSpans||(this.aggregateSpans[i]={name:t.name,start_time:t.start_time,total_time:0,num_calls:0,annotations:Object.keys(t.annotations).length>0?t.annotations:void 0,parent:t.parent||"",stopwatch_tags:e.length>0?e:void 0,type:t.type});const n=this.aggregateSpans[i];if(void 0!==t.end_time){if(n.type===a.Trace?(n.total_time=t.end_time-t.start_time,n.num_calls=1):(n.total_time+=t.end_time-t.start_time,n.num_calls+=1),Object.keys(t.annotations).length>0)if(n.annotations)for(const e in t.annotations)t.annotations.hasOwnProperty(e)&&(n.annotations[e]=t.annotations[e]);else n.annotations=t.annotations}else this._report_sw_misuse(`Span ${i} reported with undefined end_time`)}}t.JSBasicStopwatchImpl=o;t.NoopStopwatchInstance=new class{constructor(){this.name="",this.annotations={}}reset(){}attach(){}addAnnotation(e,t){}removeAnnotation(e){}popResolvedSpans(){return{}}peekResolvedSpans(){return{}}start(e,t){}end(e,t){}recordTrace(e,t){}addSpanAnnotation(e,t,i,n){}},t.createStopwatch=function(e,i,n,r=!1,a){return s?new o(e,i,n,r,a):t.NoopStopwatchInstance}})),define("metaserver/static/js/clean/js_client_stopwatch",["require","exports","tslib","metaserver/static/js/core/xhr","metaserver/static/js/clean/js_basic_stopwatch","metaserver/static/js/modules/constants/request","metaserver/static/js/core/assert","metaserver/static/js/core/browser","metaserver/static/js/core/exception"],(function(e,t,i,n,s,r,a,o,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JSStopwatch=t.ReservedAnnotationKey=void 0,r=i.__importStar(r),o=i.__importStar(o);class l{constructor(e){this.id=e}}t.ReservedAnnotationKey=l,l.REQUEST_ID=new l("dropbox.js_client_stopwatch.request_id"),l.CORRELATION_ID=new l("dropbox.js_client_stopwatch.correlation_id"),l.URL=new l("dropbox.js_client_stopwatch.url");class d{constructor(){this.GLOBAL_SW_NAME="GLOBAL_STOPWATCH",this.flush_interval=6e4,this.debugEnabled=!0,this.strictAssert=!1,this.intervalId=null,this.clientStopwatchCounter=1,this.reset()}reset(){this.globalStopwatches={},this.clientStopwatches={},this.clientStopwatchCounter=1,this.sentInitialData=!1,this.create_stopwatch(this.GLOBAL_SW_NAME),this.intervalId&&clearInterval(this.intervalId),this.intervalId=null}reset_individual_stopwatch(e){this.stopwatch_exists(e)?this.globalStopwatches[e].reset():this._report_sw_misuse(`tried to reset the stopwatch ${e} but it does not exist`)}stopwatch_exists(e){return e in this.globalStopwatches}create_stopwatch(e,t){this.stopwatch_exists(e)?this._report_sw_misuse(`tried to create a new stopwatch ${e} but it already exists`):this.globalStopwatches[e]=(0,s.createStopwatch)(e,this.strictAssert,t)}createDetachedStopwatch(e,t={}){const i=(0,s.createStopwatch)(e,this.strictAssert,t.tags,!0,t.annotations),n=new u(this.clientStopwatchCounter++,e,i,t.request_id,t.correlation_id,t.url);return this.clientStopwatches[n.id]=n,n}deleteStopwatch(e){delete this.clientStopwatches[e.id]}create_stopwatch_if_not_exist(e,t){this.stopwatch_exists(e)||this.create_stopwatch(e,t)}getStopwatch(e){return this.stopwatch_exists(e)?this.globalStopwatches[e]:(this._report_sw_misuse(`${e} doesn't exist`),null)}recordTrace(e,t={}){const i=this.getStopwatch(t.stopwatchName||this.GLOBAL_SW_NAME);if(null==i)return;const n={traceTime:t.traceTime};return i.recordTrace(e,n)}startSpan(e,t={}){const i=this.getStopwatch(t.stopwatchName||this.GLOBAL_SW_NAME);if(null==i)return;const n={startTime:t.startTime,async:t.async};return i.start(e,n)}endSpan(e,t={}){const i=this.getStopwatch(t.stopwatchName||this.GLOBAL_SW_NAME);if(null!=i)return i.end(e,{spanId:t.spanId,endTime:t.endTime})}addSpanAnnotation(e,t,i,n={}){const s=this.getStopwatch(n.stopwatchName||this.GLOBAL_SW_NAME);null!=s&&s.addSpanAnnotation(e,t,i,n.spanId)}log_stored_results(){this.sentInitialData?this._report_sw_misuse("ClientStopwatch tried to log stored results, but the stopwatch is set to log immediately"):(this.flush_current_data(),this.sentInitialData=!0,this.intervalId=setInterval(this.flush_current_data.bind(this),this.flush_interval))}_report_sw_misuse(e){e=`ClientStopwatch: ${e}`,this.strictAssert?(0,a.assert)(!1,e):(0,c.reportStack)(e,{severity:c.SEVERITY.NONCRITICAL,tags:["log_js_stopwatch"]})}flush_current_data(){for(const e in this.globalStopwatches)this.globalStopwatches.hasOwnProperty(e)&&d.logStopwatchData(this.globalStopwatches[e]);for(const e in this.clientStopwatches)this.clientStopwatches.hasOwnProperty(e)&&d.logStopwatchData(this.clientStopwatches[e].stopwatch)}static logStopwatchData(e){const t=e.popResolvedSpans(),i=e.name,n={};if(Object.keys(t).length>d.MAXSPANS){let s=0;n[i]={};for(const r in t)t.hasOwnProperty(r)&&(n[i][r]=t[r],s===d.MAXSPANS&&(n[i].annotations=e.annotations,d.send_spans(n),s=0,n[i]={}),s++)}else n[i]=t;0!==Object.keys(n[i]).length&&(n[i].annotations=e.annotations,d.send_spans(n))}static send_spans(e){const t=JSON.stringify(e),i={request_id:r.REQUEST_ID,url:o.get_href().replace("/dws2",""),aggregated_sw_data:t};(0,n.sendXhr)("/log_js_sw_data",i)}print_stopwatches_debug(){const e=this.get_debug_data();console.table&&console.groupCollapsed&&console.groupEnd&&e&&e.length>0&&(console.groupCollapsed("Request timeline"),console.table(e),console.groupEnd())}get_debug_data(){const e=[];for(const t in this.globalStopwatches)if(this.globalStopwatches.hasOwnProperty(t)){const i=this.globalStopwatches[t].peekResolvedSpans();for(const n in i)if(i.hasOwnProperty(n)){const r=i[n],a={stopwatchName:t,spanName:r.name,time:r.start_time+r.total_time};r.type!==s.TimingDataType.AsyncSpan&&r.type!==s.TimingDataType.Span||(a.startTime=r.start_time),r.type===s.TimingDataType.Span&&(a.info=`Total time: ${r.total_time}ms`),e.push(a)}}return e.sort((e,t)=>e.time-t.time),e}}d.MAXSPANS=2e3,t.JSStopwatch=new d;class u{constructor(e,t,i,n,s,r){this.sentInitialData=!1,this.strictAssert=!1,this.id=e,this.stopwatch=i,this._request_id=n,this._correlation_id=s,this._url=r,this._request_id&&this.stopwatch.addAnnotation(l.REQUEST_ID.id,this._request_id),this._correlation_id&&this.stopwatch.addAnnotation(l.CORRELATION_ID.id,this._correlation_id),this._url&&this.stopwatch.addAnnotation(l.URL.id,this._url)}set request_id(e){this._request_id=e,this._request_id?this.stopwatch.addAnnotation(l.REQUEST_ID.id,this._request_id):this.stopwatch.removeAnnotation(l.REQUEST_ID.id)}set correlation_id(e){this._correlation_id=e,this._correlation_id?this.stopwatch.addAnnotation(l.CORRELATION_ID.id,this._correlation_id):this.stopwatch.removeAnnotation(l.CORRELATION_ID.id)}set url(e){this._url=e,this._url?this.stopwatch.addAnnotation(l.URL.id,this._url):this.stopwatch.removeAnnotation(l.URL.id)}startSpan(e,t){return this.stopwatch.start(e,t)}endSpan(e,t){return this.stopwatch.end(e,t)}addSpanAnnotation(e,t,i,n){this.stopwatch.addSpanAnnotation(e,t,i,n)}recordTrace(e,t,i){this.stopwatch.recordTrace(e,{traceTime:t,annotations:i})}recordEntries(e){for(const t of e)if(t.type===s.TimingDataType.Trace)this.recordTrace(t.name,t.endTime,t.annotations);else{const e=t.startTime||0,i=this.startSpan(t.name,{startTime:Math.min(e,t.endTime),async:t.type===s.TimingDataType.AsyncSpan,annotations:t.annotations});t.endTime<e&&this.addSpanAnnotation(t.name,"negativeSpanLength",(t.endTime-e).toString(),i),this.endSpan(t.name,{spanId:i,endTime:Math.max(e,t.endTime)})}}logData(){this.sentInitialData?this.reportMisuse("ClientStopwatch tried to log stored results, but the stopwatch is set to log immediately"):(this.stopwatch.attach(),this.sentInitialData=!0,setTimeout(()=>{t.JSStopwatch.flush_current_data()},0))}addAnnotation(e,t){this.stopwatch.addAnnotation(e,t)}removeAnnotation(e){this.stopwatch.removeAnnotation(e)}reportMisuse(e){e=`ClientStopwatch: ${e}`,this.strictAssert?(0,a.assert)(!1,e):(0,c.reportStack)(e,{severity:c.SEVERITY.NONCRITICAL,tags:["log_js_stopwatch"]})}}})),define("metaserver/static/js/dropbox/proto/js_init_data/web_timing_logger/web_timing_logger",["require","exports","tslib","protobufjs/minimal"],(function(e,t,i,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=t.web_timing_logger=void 0;const s=(n=i.__importStar(n)).Reader,r=n.Writer,a=n.util,o=n.roots.default||(n.roots.default={});var c;t.default=o,t.web_timing_logger=o.web_timing_logger=((c=o.web_timing_logger||{}).WebTimingLoggerServerContext=(function(e){function e(e){if(this.subtypes={},e)for(let t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}return e.prototype.isDws=!1,e.prototype.dwsOpts=null,e.prototype.sourceType=0,e.prototype.subtypes=a.emptyObject,e.prototype.url="",e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=r.create()),null!=e.isDws&&Object.hasOwnProperty.call(e,"isDws")&&t.uint32(8).bool(e.isDws),null!=e.dwsOpts&&Object.hasOwnProperty.call(e,"dwsOpts")&&o.web_timing_logger.WebTimingLoggerServerContext.DWSOptions.encode(e.dwsOpts,t.uint32(18).fork()).ldelim(),null!=e.sourceType&&Object.hasOwnProperty.call(e,"sourceType")&&t.uint32(24).int32(e.sourceType),null!=e.subtypes&&Object.hasOwnProperty.call(e,"subtypes"))for(let i=Object.keys(e.subtypes),n=0;n<i.length;++n)t.uint32(34).fork().uint32(10).string(i[n]).uint32(18).string(e.subtypes[i[n]]).ldelim();return null!=e.url&&Object.hasOwnProperty.call(e,"url")&&t.uint32(42).string(e.url),t},e.decode=function(e,t){e instanceof s||(e=s.create(e));let i,n,r=void 0===t?e.len:e.pos+t,c=new o.web_timing_logger.WebTimingLoggerServerContext;for(;e.pos<r;){let t=e.uint32();switch(t>>>3){case 1:c.isDws=e.bool();break;case 2:c.dwsOpts=o.web_timing_logger.WebTimingLoggerServerContext.DWSOptions.decode(e,e.uint32());break;case 3:c.sourceType=e.int32();break;case 4:{c.subtypes===a.emptyObject&&(c.subtypes={});let t=e.uint32()+e.pos;for(i="",n="";e.pos<t;){let t=e.uint32();switch(t>>>3){case 1:i=e.string();break;case 2:n=e.string();break;default:e.skipType(7&t)}}c.subtypes[i]=n;break}case 5:c.url=e.string();break;default:e.skipType(7&t)}}return c},e.getTypeUrl=function(){return"type.googleapis.com/web_timing_logger.WebTimingLoggerServerContext"},e.DWSOptions=(function(e){function e(e){if(e)for(let t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}return e.prototype.isDws2=!1,e.prototype.isEarlyEnsemble=!1,e.prototype.jsPreloading=!1,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=r.create()),null!=e.isDws2&&Object.hasOwnProperty.call(e,"isDws2")&&t.uint32(8).bool(e.isDws2),null!=e.isEarlyEnsemble&&Object.hasOwnProperty.call(e,"isEarlyEnsemble")&&t.uint32(16).bool(e.isEarlyEnsemble),null!=e.jsPreloading&&Object.hasOwnProperty.call(e,"jsPreloading")&&t.uint32(24).bool(e.jsPreloading),t},e.decode=function(e,t){e instanceof s||(e=s.create(e));let i=void 0===t?e.len:e.pos+t,n=new o.web_timing_logger.WebTimingLoggerServerContext.DWSOptions;for(;e.pos<i;){let t=e.uint32();switch(t>>>3){case 1:n.isDws2=e.bool();break;case 2:n.isEarlyEnsemble=e.bool();break;case 3:n.jsPreloading=e.bool();break;default:e.skipType(7&t)}}return n},e.getTypeUrl=function(){return"type.googleapis.com/web_timing_logger.WebTimingLoggerServerContext.DWSOptions"},e})(e.DWSOptions||{}),e.SourceType=(function(){const e={},t=Object.create(e);return t[e[0]="UNKNOWN"]=0,t[e[1]="DESKTOP_WEB"]=1,t[e[2]="MOBILE_WEB"]=2,t})(),e})(c.WebTimingLoggerServerContext||{}),c)})),define("typescript/dropbox/proto/apex_metrics_web/apex_metrics_web_pb",["require","exports","@bufbuild/protobuf"],(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ApexMetricsCacheData_FilterState=t.ApexMetricsCacheData_NamespaceCoinState=t.ApexMetricsCacheData_CoinState=t.ApexMetricsCacheData=t.RecordNamespace_RecordResponse=t.RecordNamespace_StickinessV2=t.RecordNamespace_StickyBiasedCoinV2=t.RecordNamespace_MetricReportingConfigV2=t.RecordNamespace=void 0;class n extends i.Message{constructor(e){super(),i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new n).fromBinary(e,t)}static fromJson(e,t){return(new n).fromJson(e,t)}static fromJsonString(e,t){return(new n).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(n,e,t)}}t.RecordNamespace=n,n.runtime=i.proto3,n.typeName="apex_metrics_web.RecordNamespace",n.fields=i.proto3.util.newFieldList(()=>[]);class s extends i.Message{constructor(e){super(),this.metricNamespace="",this.maxTimeUntilRefreshSeconds=0,this.stopPublicationForSeconds=0,this.dropFractionOfHostsPerMetric=0,this.aggregationIntervalSeconds=0,i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new s).fromBinary(e,t)}static fromJson(e,t){return(new s).fromJson(e,t)}static fromJsonString(e,t){return(new s).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(s,e,t)}}t.RecordNamespace_MetricReportingConfigV2=s,s.runtime=i.proto3,s.typeName="apex_metrics_web.RecordNamespace.MetricReportingConfigV2",s.fields=i.proto3.util.newFieldList(()=>[{no:1,name:"metric_namespace",kind:"scalar",T:9},{no:2,name:"max_time_until_refresh_seconds",kind:"scalar",T:13},{no:3,name:"stop_publication_for_seconds",kind:"scalar",T:13},{no:4,name:"drop_samples",kind:"message",T:r},{no:5,name:"drop_periods",kind:"message",T:r},{no:6,name:"drop_fraction_of_hosts_per_metric",kind:"scalar",T:1},{no:7,name:"aggregation_interval_seconds",kind:"scalar",T:13}]);class r extends i.Message{constructor(e){super(),this.fraction=0,i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new r).fromBinary(e,t)}static fromJson(e,t){return(new r).fromJson(e,t)}static fromJsonString(e,t){return(new r).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(r,e,t)}}t.RecordNamespace_StickyBiasedCoinV2=r,r.runtime=i.proto3,r.typeName="apex_metrics_web.RecordNamespace.StickyBiasedCoinV2",r.fields=i.proto3.util.newFieldList(()=>[{no:1,name:"fraction",kind:"scalar",T:1},{no:2,name:"stickiness",kind:"message",T:a}]);class a extends i.Message{constructor(e){super(),this.limit={case:void 0},i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new a).fromBinary(e,t)}static fromJson(e,t){return(new a).fromJson(e,t)}static fromJsonString(e,t){return(new a).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(a,e,t)}}t.RecordNamespace_StickinessV2=a,a.runtime=i.proto3,a.typeName="apex_metrics_web.RecordNamespace.StickinessV2",a.fields=i.proto3.util.newFieldList(()=>[{no:1,name:"independent",kind:"message",T:i.Empty,oneof:"limit"},{no:2,name:"permanent",kind:"message",T:i.Empty,oneof:"limit"},{no:3,name:"n_results",kind:"scalar",T:13,oneof:"limit"},{no:4,name:"n_seconds",kind:"scalar",T:2,oneof:"limit"}]);class o extends i.Message{constructor(e){super(),this.reportingConfigs=[],this.publicationIntervalSeconds=0,this.maxScopesPerRequest=0,this.stopPublicationForSeconds=0,this.debugInfos=[],i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new o).fromBinary(e,t)}static fromJson(e,t){return(new o).fromJson(e,t)}static fromJsonString(e,t){return(new o).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(o,e,t)}}t.RecordNamespace_RecordResponse=o,o.runtime=i.proto3,o.typeName="apex_metrics_web.RecordNamespace.RecordResponse",o.fields=i.proto3.util.newFieldList(()=>[{no:1,name:"reporting_configs",kind:"message",T:s,repeated:!0},{no:3,name:"publication_interval_seconds",kind:"scalar",T:13},{no:4,name:"max_scopes_per_request",kind:"scalar",T:13},{no:5,name:"stop_publication_for_seconds",kind:"scalar",T:13},{no:6,name:"debug_infos",kind:"scalar",T:9,repeated:!0}]);class c extends i.Message{constructor(e){super(),i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new c).fromBinary(e,t)}static fromJson(e,t){return(new c).fromJson(e,t)}static fromJsonString(e,t){return(new c).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(c,e,t)}}t.ApexMetricsCacheData=c,c.runtime=i.proto3,c.typeName="apex_metrics_web.ApexMetricsCacheData",c.fields=i.proto3.util.newFieldList(()=>[{no:1,name:"config",kind:"message",T:o},{no:2,name:"timeStored",kind:"message",T:i.Timestamp},{no:3,name:"state",kind:"message",T:u}]);class l extends i.Message{constructor(e){super(),this.lastResult=!1,this.numTimesChecked=0,i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new l).fromBinary(e,t)}static fromJson(e,t){return(new l).fromJson(e,t)}static fromJsonString(e,t){return(new l).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(l,e,t)}}t.ApexMetricsCacheData_CoinState=l,l.runtime=i.proto3,l.typeName="apex_metrics_web.ApexMetricsCacheData.CoinState",l.fields=i.proto3.util.newFieldList(()=>[{no:1,name:"lastFlipTime",kind:"message",T:i.Timestamp},{no:2,name:"lastResult",kind:"scalar",T:8},{no:3,name:"numTimesChecked",kind:"scalar",T:13}]);class d extends i.Message{constructor(e){super(),i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new d).fromBinary(e,t)}static fromJson(e,t){return(new d).fromJson(e,t)}static fromJsonString(e,t){return(new d).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(d,e,t)}}t.ApexMetricsCacheData_NamespaceCoinState=d,d.runtime=i.proto3,d.typeName="apex_metrics_web.ApexMetricsCacheData.NamespaceCoinState",d.fields=i.proto3.util.newFieldList(()=>[{no:1,name:"dropPeriodCoin",kind:"message",T:l},{no:2,name:"dropSamplesCoin",kind:"message",T:l}]);class u extends i.Message{constructor(e){super(),this.filterID=0,this.namespaceCoinState={},i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new u).fromBinary(e,t)}static fromJson(e,t){return(new u).fromJson(e,t)}static fromJsonString(e,t){return(new u).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(u,e,t)}}t.ApexMetricsCacheData_FilterState=u,u.runtime=i.proto3,u.typeName="apex_metrics_web.ApexMetricsCacheData.FilterState",u.fields=i.proto3.util.newFieldList(()=>[{no:1,name:"filterID",kind:"scalar",T:13},{no:2,name:"namespaceCoinState",kind:"map",K:9,V:{kind:"message",T:d}}])})),define("metaserver/static/js/user_centric_perf_metrics/utils",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.waitForPageHidden=t.waitForPageLoad=void 0;t.waitForPageLoad=()=>"complete"===document.readyState?Promise.resolve():new Promise((e,t)=>{window.addEventListener("load",()=>{e()})});t.waitForPageHidden=()=>new Promise((e,t)=>{const i=t=>{"pagehide"!==t.type&&"hidden"!==document.visibilityState||(document.removeEventListener("visibilitychange",i,!0),window.removeEventListener("pagehide",i,!0),e())};document.addEventListener("visibilitychange",i,!0),window.addEventListener("pagehide",i,!0)})})),define("metaserver/static/js/user_centric_perf_metrics/annotations",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AnnotationNameEnum=void 0,(function(e){e.LONG_INPUT_DELAY_CALLBACK_LATENCY_OVERHEAD_MS="long_input_delay_callback_latency_overhead_ms",e.AVG_LONG_INPUT_DELAY_MS="long_input_delay_ms"})(t.AnnotationNameEnum||(t.AnnotationNameEnum={}))})),define("metaserver/static/js/user_centric_perf_metrics/long_input_delay_observer",["require","exports","tslib","metaserver/static/js/modules/constants/webtiming","metaserver/static/js/user_centric_perf_metrics/annotations"],(function(e,t,i,n,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LongInputDelayObserver=void 0,n=i.__importStar(n);class r{constructor(e){var t;if(this.delayThresholdMS=50,this._isSupportedEnvironment=r.isSupportedEnvironment(),this.totalInputDelayCallbackLatencyOverheadMS=0,this.totalInputDelayMS=0,this.totalInputEntryCount=0,this.avgInputDelayMS=0,this.performanceObserverCallback=e=>{const t=performance.now(),i=[],n=e.getEntries(),r=n.length;for(let e=0;e<r;e++){const t=n[e],s=t.processingStart-t.startTime;s>=this.delayThresholdMS&&(t.delay=s,i.push(t),this.totalInputDelayMS+=s)}i.length&&(this.totalInputEntryCount+=i.length,this.avgInputDelayMS=this.totalInputDelayMS/this.totalInputEntryCount,this.callback(i)),this.totalInputDelayCallbackLatencyOverheadMS+=performance.now()-t,this.addAnnotation(s.AnnotationNameEnum.LONG_INPUT_DELAY_CALLBACK_LATENCY_OVERHEAD_MS,this.totalInputDelayCallbackLatencyOverheadMS),this.addAnnotation(s.AnnotationNameEnum.AVG_LONG_INPUT_DELAY_MS,this.avgInputDelayMS)},!this._isSupportedEnvironment)return;const i=null!==(t=e.PerformanceObserverClass)&&void 0!==t?t:window.PerformanceObserver;this.performanceObserver=new i(this.performanceObserverCallback),this.delayThresholdMS=e.delayThresholdMS||this.delayThresholdMS,this.addAnnotation=e.addAnnotation||(()=>{}),this.callback=e.callback}static isSupportedEnvironment(e=n.LOG_BETA_USER_CENTRIC_PERF_METRICS){return void 0!==window&&"PerformanceObserver"in window&&"PerformanceEventTiming"in window&&e}observe(){this._isSupportedEnvironment&&this.performanceObserver.observe({entryTypes:["event"]})}disconnect(){this.performanceObserver&&this.performanceObserver.disconnect()}}t.LongInputDelayObserver=r})),define("metaserver/static/js/user_centric_perf_metrics/map_path_to_product",["require","exports","metaserver/static/js/core/exception"],(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mapPathToProduct=void 0;t.mapPathToProduct=function(e){var t,a,o;const c=e.pathname.substring(1).split("/"),l=null!==(t=c[0])&&void 0!==t?t:"",d=null!==(a=c[1])&&void 0!==a?a:"";switch(l){case"home":case"personal":case"work":return e.searchParams.has("preview")?"browse:preview":"browse";case"account":return r(d);case"preview":return"standalone_preview";case"s":case"scl":return s(c);case"share":return n(d);case"collections":case"deleted_files":case"photos":case"recents":case"requests":case"starred":case"signatures":case"trello_powerup":return l}return(0,i.reportStack)("user_centric_perf: product name could not be determined from route.",{severity:i.SEVERITY.NONCRITICAL,tags:["user_centric_perf","ttvc"],exc_extra:{edison_page:window.EDISON_PAGE_NAME,dws_page:null===(o=window.ensemble)||void 0===o?void 0:o.getPageName()}}),"UNKNOWN"};const n=e=>{switch(e){case"recents":return"shared:recents";case"folders":return"shared:folders";case"files":return"shared:files";case"links":return"shared:links";case"signatures":return"shared:signatures"}return"UNKNOWN"},s=e=>{if("s"===e[0]&&e[2])return"shared_link:file";switch(e[1]){case"fi":return"shared_link:file";case"fo":return"shared_link:folder"}return"UNKNOWN"},r=e=>{switch(e){case"connected_apps":case"default_apps":return"account:app";case"branding":return"account:branding";case"general":return"account:general";case"family":return"account:family";case"notifications":return"account:notifications";case"plan":return"account:plan";case"security":return"account:security";case"privacy":return"account:privacy"}return"UNKNOWN"}})),define("metaserver/static/js/user_centric_perf_metrics/metrics_collector",["require","exports","tslib","@dropbox/ttvc","metaserver/static/js/core/exception","web-vitals","metaserver/static/js/user_centric_perf_metrics/long_input_delay_observer","metaserver/static/js/user_centric_perf_metrics/utils","metaserver/static/js/core/cookies"],(function(e,t,i,n,s,r,a,o,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MetricsCollector=void 0;t.MetricsCollector=class{constructor(e={}){var t;this.numLongInputDelays=0,this.ttiSubscribers=new Set,this.annotations=new Map,this.getTTFB=r.getTTFB,this.getFCP=r.getFCP,this.getLCP=r.getLCP,this.getCLS=r.getCLS,this.getFID=r.getFID,this.getTTVC=n.getTTVC,this.onLongInputDelay=e=>{this.numLongInputDelays+=e.length},this.addAnnotation=(e,t)=>{this.annotations.set(e,t)};const i=null!==(t=e.LongInputDelayObserverClass)&&void 0!==t?t:a.LongInputDelayObserver;this.longInputDelayObserver=new i({callback:this.onLongInputDelay,addAnnotation:this.addAnnotation});const o=c.Cookies.read("enable_ttvc_debugging");try{(0,n.init)({debug:"ON"===o,idleTimeout:2e3})}catch(e){(0,s.reportException)({err:e,severity:"non-critical",force:!0,tags:["user_centric_perf","ttvc"]})}window.PerformanceObserver&&(this.performanceObserver=new PerformanceObserver((e,t)=>{const i=this.getTTIValue(e);i&&(this.ttiSubscribers.forEach(e=>e(i)),t.disconnect())}),this.performanceObserver.observe({entryTypes:["mark"]}))}getTTI(e){this.ttiSubscribers.add(e);const t=this.getTTIValue(performance);return t&&e(t),()=>this.ttiSubscribers.delete(e)}getTTIValue(e){let t=void 0;const i=e.getEntriesByName("time_to_interactive");if(i.length){t=i[0].startTime}return t}getLongInputDelays(e){return i.__awaiter(this,void 0,void 0,(function*(){yield(0,o.waitForPageLoad)(),this.longInputDelayObserver.observe(),yield(0,o.waitForPageHidden)(),this.longInputDelayObserver.disconnect(),e(this.numLongInputDelays)}))}}})),define("metaserver/static/js/user_centric_perf_metrics/metrics_logger",["require","exports","typescript/libraries/shared/apex-metrics/src/index","metaserver/static/js/user_centric_perf_metrics/metrics_collector","metaserver/static/js/user_centric_perf_metrics/annotations","metaserver/static/js/user_centric_perf_metrics/visually_complete_logger","metaserver/static/js/logging/hive/schemas/web-visually_complete","metaserver/static/js/edison/ui/spa_product_name","metaserver/static/js/user_centric_perf_metrics/map_path_to_product","metaserver/static/js/devtools/panels/performance/perf_hub_actions"],(function(e,t,i,n,s,r,a,o,c,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.logUserCentricPerfMetrics=t.MetricsLogger=void 0;class d{constructor(e=null,t=new n.MetricsCollector){this.AMP_NAMESPACE="user_centric_perf",this.shouldLogToAmp=!1,e&&(this._metricsReporter=e),this.metricsCollector=t}static getSingleton(){return d.instance||(d.instance=new d),d.instance}get metricsReporter(){if(!this._metricsReporter)throw new Error("Must set `metricsReporter` on MetricsLogger before deriving metrics");return this._metricsReporter}set metricsReporter(e){this._metricsReporter=e}deriveAndLogAllMetrics(){this.deriveAndLogTimeToFirstByte(),this.deriveAndLogFirstContentfulPaint(),this.deriveAndLogLargestContentfulPaint(),this.deriveAndLogFirstInputDelay(),this.deriveAndLogCumulativeLayoutShift(),this.deriveAndLogTimeToVisuallyComplete(),this.deriveAndLogNumLongInputDelays(),this.deriveAndLogTimeToConsistentlyInteractive(),this.logTimeToInteractive(),this.observeRageClicks()}deriveAndLogTimeToFirstByte(){this.metricsCollector.getTTFB(e=>{this.logMetricToAmp("time_to_first_byte_ms",e.value)})}deriveAndLogFirstContentfulPaint(){this.metricsCollector.getFCP(e=>{this.logMetricToAmp("time_to_first_contentful_paint_ms",e.value)})}deriveAndLogLargestContentfulPaint(){this.metricsCollector.getLCP(e=>{this.logMetricToAmp("time_to_largest_contentful_paint_ms",e.value);const t=new CustomEvent("largest_contentful_paint",{detail:{value:e.value}});window.dispatchEvent(t)})}deriveAndLogFirstInputDelay(){this.metricsCollector.getFID(e=>{const t=e.entries[0].startTime;this.logMetricToAmp("time_to_first_input_ms",t),this.logMetricToAmp("first_input_delay_ms",e.value)})}deriveAndLogCumulativeLayoutShift(){this.metricsCollector.getCLS(e=>{this.logMetricToAmp("cumulative_layout_shift",e.value,null)})}deriveAndLogTimeToVisuallyComplete(){this.metricsCollector.getTTVC(e=>{var t;if(e.duration<=0)return;const n=(0,c.mapPathToProduct)(new URL(window.location.toString())),s=null!==(t=(0,o.getSpaProductName)())&&void 0!==t?t:"UNKNOWN";let d="unknown";if(window.RUNNING_IN_EDISON?d="edison":window.ensemble&&(d="dws"),0===e.start){this.logMetricToAmp("time_to_visually_complete_ms",e.duration,i.TimeUnit.MILLISECONDS,{did_network_timeout:e.detail.didNetworkTimeOut.toString()});const t=e.detail.lastVisibleChange;let s="";if(t instanceof HTMLElement){s="load event: "+t.cloneNode(!1).outerHTML}else t&&(s="mutation: "+(function(e){console.log(e);const t={type:e.type,target:e.target,addedNodes:e.addedNodes,removedNodes:e.removedNodes,attributeName:e.attributeName,attributeNamespace:e.attributeNamespace};return JSON.stringify(t,(e,t)=>t instanceof HTMLElement?(t=t.cloneNode(!1)).outerHTML:null!==t&&0!==Object.entries(t).length?t:void 0," ")})(t));console.log(s),r.timeToVisuallyCompleteLogger.log(new a.VisuallyCompleteEventRow({time_to_visually_complete:Math.round(e.duration),last_visible_change:s,product_name:n}))}else this.logMetricToAmp("time_to_visually_complete_ajax_ms",e.duration,i.TimeUnit.MILLISECONDS,{product:s,navigation_type:"ajax",did_network_timeout:e.detail.didNetworkTimeOut.toString()});const u={did_network_timeout:e.detail.didNetworkTimeOut.toString()};e.start>0&&(u.product=s,u.navigation_type="ajax"),this.logMetricToAmp("time_to_visually_complete_all_ms",e.duration,i.TimeUnit.MILLISECONDS,u,!0),"UNKNOWN"!==s&&this.logMetricToAmp("time_to_visually_complete_spa_product_name_ms",e.duration,i.TimeUnit.MILLISECONDS,Object.assign(Object.assign({},u),{product:s}),!0),"UNKNOWN"!==n&&this.logMetricToAmp("ttvc",e.duration,i.TimeUnit.MILLISECONDS,Object.assign(Object.assign({},u),{product:n,web_server:d}),!0);const p=new CustomEvent("visually_complete",{detail:{value:e.duration,navigation_type:e.start>0?"ajax":"page_load"}});window.dispatchEvent(p),l.PerfHubActions.add_visually_complete({time:e.duration}),performance.mark("visually_complete",{startTime:e.duration})})}deriveAndLogNumLongInputDelays(){this.metricsCollector.getLongInputDelays(e=>{this.logMetricToAmp("num_long_input_delays",e,null);const t=this.metricsCollector.annotations.get(s.AnnotationNameEnum.LONG_INPUT_DELAY_CALLBACK_LATENCY_OVERHEAD_MS),i=this.metricsCollector.annotations.get(s.AnnotationNameEnum.AVG_LONG_INPUT_DELAY_MS);"number"==typeof t&&this.logMetricToAmp("long_input_delay_observation_overhead_ms",t),"number"==typeof i&&this.logMetricToAmp("avg_long_input_delay_ms",i)})}logTimeToInteractive(){this.metricsCollector.getTTI(e=>{const t=(0,c.mapPathToProduct)(new URL(window.location.toString()));let n="unknown";window.RUNNING_IN_EDISON?n="edison":window.ensemble&&(n="dws"),"UNKNOWN"!==t&&this.logMetricToAmp("tti",e,i.TimeUnit.MILLISECONDS,{product:t,web_server:n},!0)})}deriveAndLogTimeToConsistentlyInteractive(){}observeRageClicks(){}logMetricToAmp(e,t,n=i.TimeUnit.MILLISECONDS,s,r=!1){if(!r&&!this.shouldLogToAmp)return;const a=this.metricsReporter.createStats(this.createAMPMetric(e),s);n?a.recordDuration(t,i.TimeUnit.MILLISECONDS):a.record(t)}createAMPMetric(e){return{ns:this.AMP_NAMESPACE,name:`browser/${e}`}}}t.MetricsLogger=d,void 0!==window&&d.getSingleton();t.logUserCentricPerfMetrics=(e,t)=>{const i=d.getSingleton();i.metricsReporter=e,i.shouldLogToAmp=t,i.deriveAndLogAllMetrics()}})),define("metaserver/static/js/user_centric_perf_metrics/visually_complete_logger",["require","exports","metaserver/static/js/logging/telemetry"],(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timeToVisuallyCompleteLogger=void 0,t.timeToVisuallyCompleteLogger=new i.HiveLogger})),define("metaserver/static/js/logging/hive/schemas/web-visually_complete",["require","exports","metaserver/static/js/modules/constants/request"],(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VisuallyCompleteEventRow=void 0;t.VisuallyCompleteEventRow=class{constructor(e){this.category="web-visually_complete",this.user_id=null,this.country=null,this.referrer=null,this.session_id=null,this.user_agent=null,this.ua_browser_name=null,this.ua_browser_version=null,this.time_to_visually_complete=e.time_to_visually_complete,this.last_visible_change=e.last_visible_change,this.product_name=e.product_name,this.request_id=i.REQUEST_ID,Object.seal(this)}}})),define("metaserver/static/js/modules/core/transport/query_string_helpers",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TRACKING_PARAMS_LIST=t.parseQueryString=t.filterQueryObject=t.getQueryString=t.getTrackingParamsAsJSON=t.getTrackingParams=t.getParsedQueryString=void 0;const i=["gclid","oqa","trigger","_tk","_camp","_ad","_net","_kw","utm_campaign","utm_content","utm_medium","utm_source","utm_term","cont"];function n(e=window){return e.location.search}function s(e){const t={};if(e.length){const i=e.substring(1).replace(/&amp;/g,"&").split("&");for(const e of i){let[i,n]=e.split("=");i&&n&&(i=i.trim(),n=n.trim(),i.length&&n.length&&(t[i]=decodeURIComponent(n.replace(/\+/g," "))))}}return t}function r(e,t){return t.reduce((t,i)=>(e.hasOwnProperty(i)&&(t[i]=e[i]),t),{})}function a(e){return r(e||s(n()),i)}t.TRACKING_PARAMS_LIST=i,t.getQueryString=n,t.parseQueryString=s,t.getParsedQueryString=function(){return s(n())},t.filterQueryObject=r,t.getTrackingParams=a,t.getTrackingParamsAsJSON=function(){const e=a();return JSON.stringify(e)}})),define("typescript/libraries/shared/apex-metrics/src/index",["require","exports","tslib","typescript/libraries/shared/apex-metrics/src/clock","typescript/libraries/shared/apex-metrics/src/executor","typescript/libraries/shared/apex-metrics/src/instant","typescript/libraries/shared/apex-metrics/src/internal","typescript/libraries/shared/apex-metrics/src/metrics","typescript/libraries/shared/apex-metrics/src/metrics_reporter","typescript/libraries/shared/apex-metrics/src/no_op","typescript/libraries/shared/apex-metrics/src/types","typescript/libraries/shared/apex-metrics/src/validate","typescript/libraries/shared/apex-metrics/src/murmur","typescript/libraries/shared/apex-metrics/src/hyperloglog"],(function(e,t,i,n,s,r,a,o,c,l,d,u,p,m){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i.__exportStar(n,t),i.__exportStar(s,t),i.__exportStar(r,t),i.__exportStar(a,t),i.__exportStar(o,t),i.__exportStar(c,t),i.__exportStar(l,t),i.__exportStar(d,t),i.__exportStar(u,t),i.__exportStar(p,t),i.__exportStar(m,t)})),define("typescript/libraries/shared/apex-metrics/src/clock",["require","exports","typescript/libraries/shared/apex-metrics/src/types"],(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BrowserPerformanceClock=void 0;t.BrowserPerformanceClock=class{now(){return{value:performance.now(),unit:i.TimeUnit.MILLISECONDS}}}})),define("typescript/libraries/shared/apex-metrics/src/executor",["require","exports","typescript/libraries/shared/apex-metrics/src/instant"],(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SetTimeoutExecutor=void 0;t.SetTimeoutExecutor=class{constructor(e){this.jitterStrategy=e}executeEvery(e,t){const n=i.Instant.toMilliseconds(e),s=i.Instant.toMilliseconds(this.jitterStrategy());setTimeout(()=>{t()&&this.executeEvery(e,t)},n+s)}}})),define("typescript/libraries/shared/apex-metrics/src/instant",["require","exports","typescript/libraries/shared/apex-metrics/src/types"],(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Instant=void 0;t.Instant=class{static toMilliseconds(e){switch(e.unit){case i.TimeUnit.NANOSECONDS:return e.value/1e6;case i.TimeUnit.MILLISECONDS:return e.value;case i.TimeUnit.SECONDS:return 1e3*e.value;case i.TimeUnit.MINUTES:return 6e4*e.value;case i.TimeUnit.HOURS:return 36e5*e.value;case i.TimeUnit.DAYS:return 24*e.value*36e5}}}})),define("typescript/libraries/shared/apex-metrics/src/internal",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})),define("typescript/libraries/shared/apex-metrics/src/metrics",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})),define("typescript/libraries/shared/apex-metrics/src/metrics_reporter",["require","exports","typescript/libraries/shared/apex-metrics/src/instant","typescript/libraries/shared/apex-metrics/src/validate","typescript/libraries/shared/apex-metrics/src/hyperloglog"],(function(e,t,i,n,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MetricsReporterImpl=void 0;class r{constructor(e,t,i,n={}){this.sink=e,this.clock=t,this.originId=i,this.tags=n}static root(e,t,i=""){return new r(e,t,i)}child(e){return new r(this.sink,this.clock,this.originId,Object.assign(Object.assign({},this.tags),(0,n.validateTags)(e)))}createStats(e,t={}){return new a((0,n.validateMetric)(e),Object.assign(Object.assign({},this.tags),(0,n.validateTags)(t)),this.sink)}createCounter(e,t={}){return new o((0,n.validateMetric)(e),Object.assign(Object.assign({},this.tags),(0,n.validateTags)(t)),this.sink)}createTimer(e,t={}){return new c((0,n.validateMetric)(e),Object.assign(Object.assign({},this.tags),(0,n.validateTags)(t)),this.sink,this.clock)}createSet(e,t={}){return new l((0,n.validateMetric)(e),Object.assign(Object.assign({},this.tags),(0,n.validateTags)(t)),this.sink,this.originId)}}t.MetricsReporterImpl=r;class a{constructor(e,t,i){this.metric=e,this.tags=t,this.sink=i}record(e){d(e,this.metric,this.tags,this.sink)}recordDuration(e,t){d(i.Instant.toMilliseconds({value:e,unit:t}),this.metric,this.tags,this.sink)}}class o{constructor(e,t,i,n=0){this.metric=e,this.tags=t,this.sink=i,this.value=n}decrement(e=1){this.value-=e}increment(e=1){this.value+=e}reset(e=0){this.value=e}record(){d(this.value,this.metric,this.tags,this.sink),this.reset()}}class c{constructor(e,t,n,s,r=0){this.metric=e,this.tags=t,this.sink=n,this.clock=s,this.value=r,this.value=i.Instant.toMilliseconds(this.clock.now())}record(){d(i.Instant.toMilliseconds(this.clock.now())-this.value,this.metric,this.tags,this.sink),this.reset()}reset(){this.value=i.Instant.toMilliseconds(this.clock.now())}}class l{constructor(e,t,i,n){this.metric=e,this.tags=t,this.sink=i,this.originId=n}observe(e){if("string"!=typeof e)throw new Error("value must be a string");const t=(0,s.hash)(e);this.sink.recordSetSpan({namespace:this.metric.ns,metricName:this.metric.name,tags:this.tags,samples:[t],type:"set"})}observeOriginId(){this.observe(this.originId)}}function d(e,t,i,n){if("number"!=typeof e)throw new Error("value must be a number");n.recordSpan({namespace:t.ns,metricName:t.name,tags:i,samples:[e],type:"histogram"})}})),define("typescript/libraries/shared/apex-metrics/src/no_op",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOpExecutor=t.NoOpSink=void 0;t.NoOpSink=class{recordSpan(){}recordSetSpan(){}};t.NoOpExecutor=class{executeEvery(){}}})),define("typescript/libraries/shared/apex-metrics/src/types",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TimeUnit=void 0,(function(e){e[e.NANOSECONDS=0]="NANOSECONDS",e[e.MILLISECONDS=1]="MILLISECONDS",e[e.SECONDS=2]="SECONDS",e[e.MINUTES=3]="MINUTES",e[e.HOURS=4]="HOURS",e[e.DAYS=5]="DAYS"})(t.TimeUnit||(t.TimeUnit={}))})),define("typescript/libraries/shared/apex-metrics/src/validate",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.validateMetricName=t.validateNamespace=t.validateTags=t.validateMetric=void 0;const i=new RegExp("^[^0-9a-zA-Z]+"),n=new RegExp("[^0-9a-zA-Z._-]","g"),s=n,r=new RegExp("[^0-9a-zA-Z/._-]","g"),a=n;function o(e){return l(e,"namespace",256,i,s)}function c(e){return l(e,"metric name",256,i,r)}function l(e,t,i,n,s){const r=[];if("string"!=typeof e&&r.push("identifier is not a string"),n&&n.test(e)&&r.push("invalid prefix"),s&&s.test(e)&&r.push("invalid characters"),e.length>i&&r.push(`exceeds ${i} characters`),0===e.length&&r.push("is empty"),0!==r.length)throw new Error(`${t} identifier '${e}' is invalid: ${r}`);return e}t.validateMetric=function(e){return{ns:o(e.ns),name:c(e.name)}},t.validateTags=function(e){const t={};for(const n in e)if(e.hasOwnProperty(n)){t[l(n,"tag name",256,i,a)]=l(e[n],"tag value",256)}return t},t.validateNamespace=o,t.validateMetricName=c})),define("typescript/libraries/shared/apex-metrics/src/hyperloglog",["require","exports","typescript/libraries/shared/apex-metrics/src/murmur"],(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stripCompress=t.HyperLogLog=t.hash=void 0;const n=[1,.5,.25,.125,.0625,.03125,.015625,.0078125,.00390625,.001953125,.0009765625,.00048828125,.000244140625,.0001220703125,6103515625e-14,30517578125e-15,152587890625e-16,762939453125e-17,3814697265625e-18,19073486328125e-19,9.5367431640625e-7,4.76837158203125e-7,2.384185791015625e-7,1.1920928955078125e-7,5.960464477539063e-8,2.9802322387695312e-8,1.4901161193847656e-8,7.450580596923828e-9,3.725290298461914e-9,1.862645149230957e-9,9.313225746154785e-10,4.656612873077393e-10,2.3283064365386963e-10];t.hash=function(e){return(0,i.hash32)((0,i.stringToUtf8ByteArray)(e),538513424)};function s(e){if(8!=e.length)throw new Error("Number of registers in stripCompress routine is not 8");const t=[];let i=0;for(let t=0;t<8;t++){if(i*=32,e[t]>=32)throw new Error("Register in HLL greater than max allowed value");i+=e[t]}for(let e=0;e<5;e++)t.unshift(Number(i%256)),i=Math.floor(i/256);return t}t.HyperLogLog=class{constructor(e=[]){this.registers=new Array(512).fill(0),e.forEach(e=>this.add(e))}add(e){if(e>=2**32)throw new Error("add only accepts 32-bit unsigned integers");const t=(function(e,t){let i=1;for(;(2147483648&e)>>>0==0&&i<=t;)i++,e=e<<1>>>0;return i})(e<<9>>>0,23),i=e>>>23;t>this.registers[i]&&(this.registers[i]=t)}count(){let e=this.registers.reduce((e,t)=>e+n[t],0),t=this.registers.reduce((e,t)=>e+(0==t?1:0),0);if(512==t)return 0;let i=188686.82445861166/e;return i<=1280?t>0&&(i=512*Math.log(512/t)):i>1/30*2**32&&(i=-(2**32)*Math.log(1-i/2**32)),i}merge(e){for(let t=0;t<512;t++){const i=e.registers[t];i>this.registers[t]&&(this.registers[t]=i)}}compressed(){const e=[];for(let t=0;t<64;t++){const i=s(this.registers.slice(8*t,8*(t+1)));for(const t of i)e.push(t)}return String.fromCharCode(...e)}},t.stripCompress=s})),define("typescript/libraries/shared/apex-metrics/src/murmur",["require","exports"],(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stringToUtf8ByteArray=t.hash32=void 0;function i(e){if(4!=e.length)throw new Error("strToUint32 expected length 4 byte array");return e[0]+(e[1]<<8)+(e[2]<<16)+(e[3]<<24)}t.hash32=function(e,t){let n=t;const s=Math.floor(e.length/4);for(let t=0;t<s;t++){let s=i(e.slice(4*t,4*t+4));s=Math.imul(s,3432918353),s=(s<<15>>>0|s>>>17)>>>0,s=Math.imul(s,461845907),n^=s,n>>>=0,n=(n<<13>>>0|n>>>19)>>>0,n=Math.imul(n,5)+3864292196>>>0}let r=e.slice(4*s),a=0;const o=3&r.length;return 3==o&&(a^=r[2]<<16>>>0,a>>>=0),o>=2&&(a^=r[1]<<8>>>0,a>>>=0),o>=1&&(a^=r[0],a=Math.imul(a,3432918353),a=(a<<15>>>0|a>>>17)>>>0,a=Math.imul(a,461845907),n^=a,n>>>=0),n^=e.length,n>>>=0,n^=n>>>16,n>>>=0,n=Math.imul(n,2246822507),n^=n>>>13,n>>>=0,n=Math.imul(n,3266489909),n^=n>>>16,n>>>=0,n},t.stringToUtf8ByteArray=function(e){const t=[];let i=0;for(let n=0;n<e.length;n++){const s=e.charCodeAt(n);s<128?t[i++]=s:s<2048?(t[i++]=s>>6|192,t[i++]=63&s|128):(t[i++]=s>>12|224,t[i++]=s>>6&63|128,t[i++]=63&s|128)}return t}})),define("typescript/libraries/shared/apex-metrics/src/sink/apiv2_sink",["require","exports","tslib","typescript/libraries/shared/apex-metrics/src/index","typescript/libraries/shared/apex-metrics/src/sink/coin","typescript/libraries/shared/apex-metrics/src/sink/database","typescript/libraries/shared/apex-metrics/src/sink/filter","typescript/libraries/shared/apex-metrics/src/sink/instrumentation","@bufbuild/protobuf","typescript/dropbox/proto/apex_metrics_web/apex_metrics_web_pb","typescript/libraries/shared/apex-metrics/src/sink/serialization"],(function(e,t,i,n,s,r,a,o,c,l,d){"use strict";var u;Object.defineProperty(t,"__esModule",{value:!0}),t.Apiv2MetricsSink=t._ORIGIN_IDENTIFIER_KEY=t.makeDefaultCacheFactory=t._PERSISTENTCACHE_KEY=t.makeDefaultInitialization=t.makeNopExceptionReporter=t.makeNopPlatformDetector=t.CLIENT_VERSION=t.PublishType=void 0,l=i.__importStar(l),(function(e){e.ALLOWED="allowed",e.DENIED="denied"})(u=t.PublishType||(t.PublishType={}));const p={".tag":"trigger_heartbeat"},m={".tag":"trigger_publish"};t.CLIENT_VERSION=24;function _(e,i,n,s,r){const a=[];return i.forEach(e=>a.push(e)),{scopes:e,known_namespaces:a,environment:"prod",artifact_name:"dropbox-web",artifact_version:"0000000000000000000000000000000000000000",client_metadata:{client_version:t.CLIENT_VERSION,implementation:{".tag":"typescript"}},trigger:n,os:s,origin_identifier:r}}t.makeNopPlatformDetector=function(){return{detectBrowser:()=>"other",detectOS:()=>({name:{".tag":"unknown_os"},version:"unknown"})}},t.makeNopExceptionReporter=function(){return{reportException:e=>{},reportStack:(e,t)=>{}}},t.makeDefaultInitialization=function(e,n,r){return(a,o)=>i.__awaiter(this,void 0,void 0,(function*(){let i=[];if(a){const e=(function(e,i){const n=e.getItem(t._PERSISTENTCACHE_KEY);if(null===n)return null;const r=Date.now()/1e3;let a,o=[];try{a=(0,d.unmarshalProto)(n,l.ApexMetricsCacheData)}catch(e){return i.reportException({err:e,tags:["js:web:amp-sink","js:web:amp-sink/local-storage"],severity:"non-critical"}),null}if(!a.config||!a.state||!a.timeStored)return i.reportStack("Sink cache was missing data",{tags:["js:web:amp-sink","js:web:amp-sink/local-storage"]}),null;const c=r-(u=a.timeStored.seconds,Number(u.toString()));var u;if(c<0)return i.reportStack("Sink cache was stored in the future instead of the past",{tags:["js:web:amp-sink","js:web:amp-sink/local-storage"],exc_extra:{cacheDataAge:c}}),null;const p={};a.config&&(o=a.config.reportingConfigs.map(e=>e.metricNamespace),p.reporting_configs=a.config.reportingConfigs?a.config.reportingConfigs.filter(e=>c<e.maxTimeUntilRefreshSeconds).map(e=>({metric_namespace:e.metricNamespace,max_time_until_refresh_seconds:e.maxTimeUntilRefreshSeconds,stop_publication_for_seconds:e.stopPublicationForSeconds,drop_samples:e.dropSamples?(0,s.protobufCoinToAPIv2Coin)(e.dropSamples):void 0,drop_periods:e.dropPeriods?(0,s.protobufCoinToAPIv2Coin)(e.dropPeriods):void 0,drop_fraction_of_hosts_per_metric:e.dropFractionOfHostsPerMetric,aggregation_interval_seconds:e.aggregationIntervalSeconds})):[],p.publication_interval_seconds=a.config.publicationIntervalSeconds,p.max_scopes_per_request=a.config.maxScopesPerRequest,p.stop_publication_for_seconds=a.config.stopPublicationForSeconds,p.debug_infos=a.config.debugInfos);return{config:p,state:a.state,knownNamespaces:o}})(a,r);if(e){i=e.knownNamespaces;const t=new Set;if(e.config.reporting_configs.forEach(e=>t.add(e.metric_namespace)),!i.some(e=>!t.has(e)))return e}}const c=new Set;i.forEach(e=>c.add(e));const u=n.detectOS(),m=yield e(),h=(yield m.clientMetricsRecord(_([],c,p,u,o))).result,g=Math.floor(4294967296*Math.random())>>>0;return{knownNamespaces:i,config:h,state:new l.ApexMetricsCacheData_FilterState({filterID:g,namespaceCoinState:{}})}}))},t._PERSISTENTCACHE_KEY="amp-sink-cache",t.makeDefaultCacheFactory=function(){return()=>{try{return window.localStorage||null}catch(e){return null}}},t._ORIGIN_IDENTIFIER_KEY="amp-sink-origin-id";class h{emit(e,...t){return!0}}t.Apiv2MetricsSink=class{constructor(e,i,n,s,r,a,c,l,d,u,p=new h){this.clientFactory=e,this.clock=i,this.initializer=n,this.cacheFactory=s,this.executor=r,this.randomEngine=a,this.databaseFactory=c,this.platformDetector=l,this.excReporter=d,this.eventEmitter=p,this.nextRequest=null,this.spanGroupFilter=null,this.knownNamespaces=new Set,this.bufferedSpans=[],this.bufferedSetSpans=[],this.instrumentation=o.Instrumentation.empty(),this.blackoutCallback=null,this.publishTimer=null,this.database=null,this.cache=this.cacheFactory(),this.originIdentifier=(function(e,i){if(e){let n=e.getItem(t._ORIGIN_IDENTIFIER_KEY);return null===n&&(n=i(),e.setItem(t._ORIGIN_IDENTIFIER_KEY,n)),n}return""})(this.cache,u),this.currentRequest=this.initializer(this.cache,this.originIdentifier).then(e=>(e&&this.updateConfiguration(e.config,e.state),this.eventEmitter.emit("initialized"),e.config||null))}getOriginId(){return this.originIdentifier}updateConfiguration(e,i){const{reporting_configs:r=[],stop_publication_for_seconds:a,publication_interval_seconds:o}=e,u=new Set;r.forEach(e=>{this.knownNamespaces.add(e.metric_namespace),u.add(e.metric_namespace)}),this.updateBlackoutCallback({value:a,unit:n.TimeUnit.SECONDS}),this.updatePublishTimer({value:o,unit:n.TimeUnit.SECONDS}),this.updateSpanGroupFilter(e,i,u),this.cache&&(function(e,i,n){try{const r=Math.floor(Date.now()/1e3),a=new l.ApexMetricsCacheData({config:new l.RecordNamespace_RecordResponse({reportingConfigs:i.reporting_configs?i.reporting_configs.map(e=>new l.RecordNamespace_MetricReportingConfigV2({metricNamespace:e.metric_namespace,maxTimeUntilRefreshSeconds:e.max_time_until_refresh_seconds,stopPublicationForSeconds:e.stop_publication_for_seconds,dropSamples:e.drop_samples?(0,s.APIv2CoinToProtobufCoin)(e.drop_samples):void 0,dropPeriods:e.drop_periods?(0,s.APIv2CoinToProtobufCoin)(e.drop_periods):void 0,dropFractionOfHostsPerMetric:e.drop_fraction_of_hosts_per_metric,aggregationIntervalSeconds:e.aggregation_interval_seconds})):[],publicationIntervalSeconds:i.publication_interval_seconds,maxScopesPerRequest:i.max_scopes_per_request,stopPublicationForSeconds:i.stop_publication_for_seconds,debugInfos:i.debug_infos||[]}),timeStored:c.Timestamp.fromDate(new Date(1e3*r)),state:n});e.setItem(t._PERSISTENTCACHE_KEY,(0,d.marshalProto)(a))}catch(e){}})(this.cache,e,i)}updateSpanGroupFilter(e,t,i){const{reporting_configs:n=[],max_scopes_per_request:s}=e,r=new Set,o=i.values();for(let e=o.next();!e.done;e=o.next())r.add(e.value);const c=(0,a.makeNamespaceMap)(n,t);this.spanGroupFilter=this.spanGroupFilter?this.spanGroupFilter.extend(s,c,r):new a.SpanGroupFilter(t.filterID,this.randomEngine,this.clock,s,c,r)}updateBlackoutCallback(e){0!==e.value?(this.blackoutCallback=()=>(this.blackoutCallback=null,this.eventEmitter.emit("publicationResumed"),!1),this.eventEmitter.emit("publicationPaused"),this.executor.executeEvery(e,this.blackoutCallback)):this.blackoutCallback=null}updatePublishTimer(e){const t=e.unit===n.TimeUnit.SECONDS?e.value:n.Instant.toMilliseconds(e)/1e3;if(0===e.value)return void(this.publishTimer=null);if(this.publishTimer&&n.Instant.toMilliseconds(this.publishTimer.period)===n.Instant.toMilliseconds(e))return;const s={period:e,callback:()=>this.publishTimer===s&&(this.nextRequest=this.currentRequest.then(()=>i.__awaiter(this,void 0,void 0,(function*(){this.nextRequest=null;const e=Math.floor(Date.now()/1e3),i=yield this.getDB();if(i)try{(yield(0,r.checkAndSetPublishTime)(i,e,t))&&(this.currentRequest=this.send())}catch(e){this.excReporter.reportException({err:e,tags:["js:web:amp-sink"],severity:"operational"})}}))),!0)};this.publishTimer=s,this.executor.executeEvery(this.publishTimer.period,this.publishTimer.callback)}send(){return i.__awaiter(this,void 0,void 0,(function*(){if(this.blackoutCallback)return this.eventEmitter.emit("publish",u.DENIED),null;const e=Math.floor(Date.now()/1e3),t={browser:this.platformDetector.detectBrowser()},i=yield this.getDB();if(!i)return null;let n,s,a,c,l;try{({scopes:n,storedNamespaces:s,spansRetained:a,samplesRetainedByNs:c,observationsRetained:l}=yield this.spanGroupFilter.partitionAndSerializeSpans(i,t,e,[o.SELF_INSTRUMENTATION_NAMESPACE]))}catch(e){return this.excReporter.reportException({err:e,tags:["js:web:amp-sink"],severity:"operational"}),null}let d=o.Instrumentation.empty();d.retainedSpans+=a;let p=0;c.forEach((e,t)=>{o.Instrumentation.incrementRetainedSamples(d,t,e),p+=e});let h=n.length>0;if(this.knownNamespaces.forEach(e=>s.add(e)),!h){const e=this.spanGroupFilter.getConfiguredNamespaces(),t=s.values();for(let i=t.next();!i.done;i=t.next())if(!e.has(i.value)){h=!0;break}}let g=null;if(h){d=yield(0,r.loadInstrumentation)(i,d);const e=this.platformDetector.detectOS(),o=_(n,s,m,e,this.originIdentifier),c=this.clock.now();d.requestAttempts++;try{const i=yield this.clientFactory();g=(yield i.clientMetricsRecord(o)).result,d=yield this.reportInstrumentation(e,d,c,t)}catch(e){d.requestDroppedSpans+=a,d.requestDroppedSamples+=p,d.requestDroppedSetObservations+=l}g&&this.updateConfiguration(g,this.spanGroupFilter.getState())}return yield(0,r.storeInstrumentation)(i,d),this.eventEmitter.emit("publish",u.ALLOWED),g}))}reportInstrumentation(e,s,r,a){return i.__awaiter(this,void 0,void 0,(function*(){const i=n.Instant.toMilliseconds(this.clock.now())-n.Instant.toMilliseconds(r);if((function(e){return!!e.name&&("android"===e.name[".tag"]||"ios"===e.name[".tag"])})(e))try{const n=Object.assign({client_version:t.CLIENT_VERSION.toString()},a),r=_([o.Instrumentation.toScope(s,this.originIdentifier,i,n)],new Set([o.SELF_INSTRUMENTATION_NAMESPACE]),m,e,this.originIdentifier),c=yield this.clientFactory();return yield c.clientMetricsRecord(r),o.Instrumentation.empty()}catch(e){return s}return o.Instrumentation.report(s,n.MetricsReporterImpl.root(this,this.clock,this.originIdentifier),i,t.CLIENT_VERSION)}))}getDB(){return i.__awaiter(this,void 0,void 0,(function*(){return this.database||(this.database=yield this.databaseFactory()),this.database}))}recordSpan(e){if(e.namespace!==o.SELF_INSTRUMENTATION_NAMESPACE){let t="UNCONFIGURED";this.spanGroupFilter&&this.spanGroupFilter.getConfiguredNamespaces().has(e.namespace)&&(t=e.namespace),this.instrumentation.submittedSpans++,o.Instrumentation.incrementSubmittedSamples(this.instrumentation,t,e.samples.length)}this.knownNamespaces.add(e.namespace),this.bufferedSpans.push(e),this.maybeScheduleNextRequest()}recordSetSpan(e){if(e.namespace!==o.SELF_INSTRUMENTATION_NAMESPACE){let t="UNCONFIGURED";this.spanGroupFilter&&this.spanGroupFilter.getConfiguredNamespaces().has(e.namespace)&&(t=e.namespace),o.Instrumentation.incrementSetObservations(this.instrumentation,t,e.samples.length)}this.knownNamespaces.add(e.namespace),this.bufferedSetSpans.push(e),this.maybeScheduleNextRequest()}maybeScheduleNextRequest(){this.nextRequest||(this.nextRequest=this.currentRequest.then(()=>i.__awaiter(this,void 0,void 0,(function*(){const e=yield this.getDB();if(!e)return;const t=this.bufferedSpans,i=this.bufferedSetSpans;this.bufferedSpans=[],this.bufferedSetSpans=[];const n=this.instrumentation;this.instrumentation=o.Instrumentation.empty();try{yield Promise.all([(0,r.storeIncomingSpans)(e,t),(0,r.storeIncomingSetSpans)(e,i),(0,r.storeInstrumentation)(e,n)])}catch(e){this.excReporter.reportException({err:e,tags:["js:web:amp-sink"],severity:"operational"})}this.publishTimer||(this.currentRequest=this.send()),this.nextRequest=null}))))}}})),define("typescript/libraries/shared/apex-metrics/src/sink/coin",["require","exports","tslib","typescript/libraries/shared/apex-metrics/src/index","typescript/dropbox/proto/apex_metrics_web/apex_metrics_web_pb","@bufbuild/protobuf"],(function(e,t,i,n,s,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.observeCoin=t.APIv2CoinToProtobufCoin=t.protobufCoinToAPIv2Coin=t.newCoinState=void 0,s=i.__importStar(s),t.newCoinState=function(){return new s.ApexMetricsCacheData_CoinState({lastFlipTime:void 0,lastResult:!1,numTimesChecked:0})},t.protobufCoinToAPIv2Coin=function(e){let t=void 0;if(e.stickiness&&e.stickiness.limit)switch(e.stickiness.limit.case){case"independent":t={".tag":"independent"};break;case"permanent":t={".tag":"permanent"};break;case"nResults":t={".tag":"n_results",n_results:e.stickiness.limit.value};break;case"nSeconds":t={".tag":"n_seconds",n_seconds:e.stickiness.limit.value}}return{fraction:null!==e.fraction?e.fraction:void 0,stickiness:t?{limit:t}:void 0}};t.APIv2CoinToProtobufCoin=function(e){let t=void 0;if(e.stickiness&&e.stickiness.limit)switch(e.stickiness.limit[".tag"]){case"independent":t={limit:{case:"independent",value:new r.Empty}};break;case"permanent":t={limit:{case:"permanent",value:new r.Empty}};break;case"n_results":t={limit:{case:"nResults",value:e.stickiness.limit.n_results}};break;case"n_seconds":t={limit:{case:"nSeconds",value:e.stickiness.limit.n_seconds}}}return new s.RecordNamespace_StickyBiasedCoinV2({fraction:e.fraction,stickiness:t?new s.RecordNamespace_StickinessV2(t):void 0})},t.observeCoin=function(e,t,i){if(!t.stickiness||!t.stickiness.limit)return{nextState:i,result:!1};const a=Date.now()/1e3,{lastFlipTime:o=r.Timestamp.fromDate(new Date(0)),lastResult:c,numTimesChecked:l=0}=i;let d=!1;switch(t.stickiness.limit[".tag"]){case"n_results":d=null===l||l%t.stickiness.limit.n_results==0;break;case"n_seconds":if(!o){d=!0;break}d=n.Instant.toMilliseconds({value:a-(u=o.seconds,Number(u.toString())),unit:n.TimeUnit.SECONDS})>n.Instant.toMilliseconds({value:t.stickiness.limit.n_seconds,unit:n.TimeUnit.SECONDS});break;case"permanent":d=0===l;break;case"independent":d=!0;break;case"other":default:return{nextState:i,result:!1}}var u;if(d){const i=e()<(t.fraction||0);return{nextState:new s.ApexMetricsCacheData_CoinState({lastFlipTime:r.Timestamp.fromDate(new Date(1e3*a)),lastResult:i,numTimesChecked:l?l+1:1}),result:i}}return{nextState:new s.ApexMetricsCacheData_CoinState(Object.assign(Object.assign({},i),{numTimesChecked:l?l+1:1})),result:!!c}}})),define("typescript/libraries/shared/apex-metrics/src/sink/database",["require","exports","tslib","typescript/libraries/shared/apex-metrics/src/sink/instrumentation"],(function(e,t,i,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.loadInstrumentation=t.storeInstrumentation=t.storeIncomingSetSpans=t.storeIncomingSpans=t.checkAndSetPublishTime=t.getDatabase=t.getNamespaceRange=t.INSTRUMENTATION_STORE_KEY=t.INSTRUMENTATION_STORE=t.CONTROL_VALUE_LASTPUBLISHTIME=t.CONTROL_VALUE_STORE=t.NAMESPACE_INDEX=t.SET_STORE=t.SPAN_STORE=t.DATABASE_VERSION=void 0;function s(e,i,n){const s=e.result,r=e=>{s.removeEventListener("error",r),n(e)};s.addEventListener("error",r),e.transaction.addEventListener("complete",()=>{s.removeEventListener("error",r)}),e.transaction.addEventListener("error",e=>{s.removeEventListener("error",r),n(e)});const a=(e,t)=>e.oldVersion<t&&(null===e.newVersion||e.newVersion&&e.newVersion>=t);if(a(i,1))try{s.createObjectStore(t.SPAN_STORE,{keyPath:["namespace","tagNames","tagValues"]}).createIndex(t.NAMESPACE_INDEX,"namespace",{unique:!1}),s.createObjectStore(t.CONTROL_VALUE_STORE,{keyPath:"name"})}catch(e){return void r(e)}if(a(i,2)){const i=e.transaction.objectStore(t.SPAN_STORE).openCursor();i.addEventListener("success",()=>{const e=i.result;if(!e)return;let t=!1;for(const i in e.value.spans)e.value.spans.hasOwnProperty(i)&&(t=!0,e.value.spans[i]={spanCount:0,samples:e.value.spans[i]});t&&e.update(e.value),e.continue()})}if(a(i,3))try{s.createObjectStore(t.INSTRUMENTATION_STORE,{keyPath:"name"})}catch(e){return void r(e)}if(a(i,4))try{e.transaction.objectStore(t.SPAN_STORE).clear(),e.transaction.objectStore(t.INSTRUMENTATION_STORE).clear()}catch(e){return void r(e)}if(a(i,5))try{s.createObjectStore(t.SET_STORE,{keyPath:["namespace","tagNames","tagValues"]}).createIndex(t.NAMESPACE_INDEX,"namespace",{unique:!1})}catch(e){return void r(e)}if(a(i,6))try{e.transaction.objectStore(t.SPAN_STORE).clear(),e.transaction.objectStore(t.SET_STORE).clear(),e.transaction.objectStore(t.INSTRUMENTATION_STORE).clear()}catch(e){return void r(e)}}function r(e,t,i,n){return Promise.all(t.map(t=>new Promise((s,r)=>{let a;try{a=e.transaction(i,"readwrite")}catch(e){if(e instanceof DOMException&&("InvalidStateError"===e.name||11===e.code))return void s();throw e}const o=a.objectStore(i);a.addEventListener("complete",e=>s()),a.addEventListener("error",e=>r(e));const c=[],l=[];for(const e in t.tags)t.tags.hasOwnProperty(e)&&(c.push(e),l.push(t.tags[e]));const d=o.get([t.namespace,c,l]);d.addEventListener("success",()=>{const e=d.result?d.result:{namespace:t.namespace,tagNames:c,tagValues:l,spans:{}};e.spans[t.metricName]||(e.spans[t.metricName]={spanCount:0,samples:[]}),e.spans[t.metricName].spanCount++,e.spans[t.metricName].samples=n(e.spans[t.metricName].samples.concat(t.samples)),o.put(e)})})))}function a(e,t,i){try{return e.transaction(t,i)}catch(e){if(e instanceof DOMException&&("InvalidStateError"===e.name||11===e.code))return null;throw e}}function o(e,t){return new Promise((i,n)=>{const s=e.get(t);s.addEventListener("success",()=>{i(s.result)}),s.addEventListener("error",e=>{n(e)})})}t.DATABASE_VERSION=6,t.SPAN_STORE="spans",t.SET_STORE="set_spans",t.NAMESPACE_INDEX="namespace",t.CONTROL_VALUE_STORE="controlValues",t.CONTROL_VALUE_LASTPUBLISHTIME="lastPublishTime",t.INSTRUMENTATION_STORE="selfInstrumentation",t.INSTRUMENTATION_STORE_KEY="instrumentation",t.getNamespaceRange=function(e,i){return new Promise((n,s)=>{const r=e.index(t.NAMESPACE_INDEX).getKey(IDBKeyRange.lowerBound(i,!0));r.addEventListener("success",()=>{if(r.result){const e=r.result[0];n(IDBKeyRange.bound([i],[e],!1,!0))}else n(IDBKeyRange.lowerBound([i]))}),r.addEventListener("error",e=>{s(e)})})},t.getDatabase=function(e=t.DATABASE_VERSION){return i.__awaiter(this,void 0,void 0,(function*(){let t=null;if("undefined"==typeof indexedDB)return t;try{t=yield new Promise((t,i)=>{indexedDB.open("unused",1);const n=indexedDB.open("apexMetrics",e);n.addEventListener("success",()=>{t(n.result)}),n.addEventListener("error",e=>{i(e)}),n.addEventListener("upgradeneeded",e=>{try{s(n,e,i)}catch(e){i(e)}})})}catch(i){i.target&&i.target.error&&i.target.error.name&&"VersionError"===i.target.error.name&&(yield new Promise((e,t)=>{const i=indexedDB.deleteDatabase("apexMetrics");i.addEventListener("success",()=>e()),i.addEventListener("error",e=>t(e))}),t=yield new Promise((t,i)=>{const n=indexedDB.open("apexMetrics",e);n.addEventListener("success",()=>t(n.result)),n.addEventListener("error",e=>i(e)),n.addEventListener("upgradeneeded",e=>{try{s(n,e,i)}catch(e){i(e)}})}))}return t}))},t.checkAndSetPublishTime=function(e,n,s){return new Promise((r,a)=>i.__awaiter(this,void 0,void 0,(function*(){let i;try{i=e.transaction(t.CONTROL_VALUE_STORE,"readwrite").objectStore(t.CONTROL_VALUE_STORE)}catch(e){if(e instanceof DOMException&&("InvalidStateError"===e.name||11===e.code))return void r(!1);throw e}const o=i.get(t.CONTROL_VALUE_LASTPUBLISHTIME);o.addEventListener("success",()=>{const e=o.result;if(e&&n-+e.value<s)return void r(!1);const c=i.put({name:t.CONTROL_VALUE_LASTPUBLISHTIME,value:n});c.addEventListener("success",()=>{r(!0)}),c.addEventListener("error",e=>{a(e)})}),o.addEventListener("error",e=>{a(e)})})))},t.storeIncomingSpans=function(e,i){return r(e,i,t.SPAN_STORE,e=>(e.sort(),e))},t.storeIncomingSetSpans=function(e,i){return r(e,i,t.SET_STORE,e=>[...new Set(e).values()])},t.storeInstrumentation=function(e,s){return new Promise((r,c)=>i.__awaiter(this,void 0,void 0,(function*(){var i,l;const d=a(e,t.INSTRUMENTATION_STORE,"readwrite");if(null===d)return void r();const u=d.objectStore(t.INSTRUMENTATION_STORE);d.addEventListener("complete",()=>{r()}),d.addEventListener("error",c);const p=null!==(l=null===(i=yield o(u,t.INSTRUMENTATION_STORE_KEY))||void 0===i?void 0:i.value)&&void 0!==l?l:n.Instrumentation.empty(),m=n.Instrumentation.merge(s,p);yield(function(e,t){return new Promise((i,n)=>{const s=e.put(t);s.addEventListener("success",()=>{i()}),s.addEventListener("error",e=>{n(e)})})})(u,{name:t.INSTRUMENTATION_STORE_KEY,value:m})})))},t.loadInstrumentation=function(e,s){return new Promise((r,c)=>i.__awaiter(this,void 0,void 0,(function*(){var i,l;const d=a(e,t.INSTRUMENTATION_STORE,"readwrite");if(null===d)return void r(s);d.addEventListener("error",c);const u=d.objectStore(t.INSTRUMENTATION_STORE),p=null!==(l=null===(i=yield o(u,t.INSTRUMENTATION_STORE_KEY))||void 0===i?void 0:i.value)&&void 0!==l?l:n.Instrumentation.empty();d.addEventListener("complete",()=>{r(n.Instrumentation.merge(s,p))}),(function(e,t){new Promise((i,n)=>{const s=e.delete(t);s.addEventListener("success",()=>{i()}),s.addEventListener("error",e=>{n(e)})})})(u,t.INSTRUMENTATION_STORE_KEY)})))}})),define("typescript/libraries/shared/apex-metrics/src/sink/filter",["require","exports","tslib","typescript/libraries/shared/apex-metrics/src/sink/coin","typescript/libraries/shared/apex-metrics/src/sink/database","typescript/libraries/shared/apex-metrics/src/sink/serialization","typescript/dropbox/proto/apex_metrics_web/apex_metrics_web_pb","typescript/libraries/shared/apex-metrics/src/hyperloglog","typescript/dropbox/proto/apex_metrics_web/apex_metrics_web_pb"],(function(e,t,i,n,s,r,a,o,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SpanGroupFilter=t.makeNamespaceMap=void 0,a=i.__importStar(a);function l(e,t){return i.__awaiter(this,void 0,void 0,(function*(){let i=null;if(crypto.subtle&&window.TextEncoder){const e=new TextEncoder,n=yield crypto.subtle.digest("SHA-256",e.encode(t));i=new Uint32Array(n).reduce((e,t)=>e^t)}return null===i?0:((i^e)>>>0)/4294967296}))}t.makeNamespaceMap=function(e,t){const i={};for(const s of e){const e=s.metric_namespace;i[e]={dropFractionOfHostsPerMetric:s.drop_fraction_of_hosts_per_metric||null,dropPeriodCoin:s.drop_periods?{config:s.drop_periods,state:t.namespaceCoinState&&t.namespaceCoinState[e]&&t.namespaceCoinState[e].dropPeriodCoin||(0,n.newCoinState)()}:null,dropSamplesCoin:s.drop_samples?{config:s.drop_samples,state:t.namespaceCoinState&&t.namespaceCoinState[e]&&t.namespaceCoinState[e].dropSamplesCoin||(0,n.newCoinState)()}:null}}return i};class d{constructor(e,t,i,n,s,r){this.filterID=e,this.randomEngine=t,this.clock=i,this.maxScopes=n,this.namespaceMap=s,this.configuredNamespaces=r}extend(e,t,i){return new d(this.filterID,this.randomEngine,this.clock,e||this.maxScopes,Object.assign(Object.assign({},this.namespaceMap),t),i)}getState(){const e={filterID:this.filterID,namespaceCoinState:{}};for(const t in this.namespaceMap)this.namespaceMap.hasOwnProperty(t)&&(e.namespaceCoinState[t]=new c.ApexMetricsCacheData_NamespaceCoinState({dropPeriodCoin:this.namespaceMap[t].dropPeriodCoin?new c.ApexMetricsCacheData_CoinState(Object.assign({},this.namespaceMap[t].dropPeriodCoin.state)):void 0,dropSamplesCoin:this.namespaceMap[t].dropSamplesCoin?new c.ApexMetricsCacheData_CoinState(Object.assign({},this.namespaceMap[t].dropSamplesCoin.state)):void 0}));return new a.ApexMetricsCacheData_FilterState(e)}getConfiguredNamespaces(){return this.configuredNamespaces}partitionAndSerializeSpans(e,t,a,c){return i.__awaiter(this,void 0,void 0,(function*(){return new Promise((d,u)=>{const p=[];let m=0;const _=new Map;let h,g=0;const f=new Set;try{h=e.transaction([s.SPAN_STORE,s.SET_STORE],"readwrite")}catch(e){if(e instanceof DOMException&&("InvalidStateError"===e.name||11===e.code))return void d({scopes:[],storedNamespaces:f,spansRetained:0,samplesRetainedByNs:new Map,observationsRetained:0});throw e}const v=new Map,S=new Set;h.addEventListener("complete",()=>d({scopes:p,storedNamespaces:f,spansRetained:m,samplesRetainedByNs:_,observationsRetained:g})),h.addEventListener("error",e=>u(e));const w=[{storeName:s.SPAN_STORE,serializeSamplesFunc:(e,t,i,n,s)=>{var r;c.includes(n)||(m+=s,_.set(n,(null!==(r=_.get(n))&&void 0!==r?r:0)+i.length)),(function(e,t,i){t.metrics.push({name:{value:{".tag":"string_value",string_value:e}},data:{".tag":"numerical_data",samples:i}})})(e,t,i)}},{storeName:s.SET_STORE,serializeSamplesFunc:(e,t,i,n,s)=>{c.includes(n)||(g+=i.length),(function(e,t,i){i.length>80?t.metrics.push({name:{value:{".tag":"string_value",string_value:e}},data:{".tag":"set_data",hyperloglog:{registers:new o.HyperLogLog(i).compressed()}}}):t.metrics.push({name:{value:{".tag":"string_value",string_value:e}},data:{".tag":"set_data",samples:i}})})(e,t,i)}}];for(const{storeName:e,serializeSamplesFunc:o}of w){const c=h.objectStore(e);let d;try{d=c.index(s.NAMESPACE_INDEX)}catch(e){return void u(e)}const m=d.count();m.addEventListener("success",()=>{if(0===m.result)return;const e=d.openKeyCursor(null,"nextunique");e.addEventListener("success",()=>i.__awaiter(this,void 0,void 0,(function*(){var d;const m=e.result;if(!m)return;const _=m.key;if(0!==this.maxScopes&&p.length===this.maxScopes&&!S.has(_))return;if(f.add(_),!this.configuredNamespaces.has(_))return void m.continue();const{dropPeriodCoin:h,dropSamplesCoin:g,dropFractionOfHostsPerMetric:w}=this.namespaceMap[_]||{};let b;try{b=yield(0,s.getNamespaceRange)(c,_)}catch(e){return void u(e)}if(h){const{result:e,nextState:t}=(0,n.observeCoin)(this.randomEngine,h.config,h.state);if(h.state=t,e)return c.delete(b),void m.continue()}const T=null!==(d=v.get(_))&&void 0!==d?d:{metric_namespace:_,timestamp_sec:a,tags:(0,r.formatTags)(t),descendants:[]};v.set(_,T);const y=c.openCursor(b);y.addEventListener("success",()=>i.__awaiter(this,void 0,void 0,(function*(){const e=y.result;if(!e)return T.descendants.length>0&&!S.has(_)&&(p.push(T),S.add(_)),void m.continue();const t={tags:(0,r.zipTags)(e.value.tagNames,e.value.tagValues),metrics:[]},i=e.value.spans;for(const e in i){if(!i.hasOwnProperty(e))continue;if(w){if((yield l(this.filterID,e))<w)continue}let s=i[e].samples;if(g&&(s=s.filter(e=>{const{result:t,nextState:i}=(0,n.observeCoin)(this.randomEngine,g.config,g.state);return g.state=i,!t})),0===s.length)continue;const r=i[e].spanCount;o(e,t,s,_,r)}t.metrics.length>0&&T.descendants.push(t),e.delete(),e.continue()})))})))})}})}))}}t.SpanGroupFilter=d})),define("typescript/libraries/shared/apex-metrics/src/sink/index",["require","exports","typescript/libraries/shared/apex-metrics/src/index","typescript/libraries/shared/apex-metrics/src/sink/database","typescript/libraries/shared/apex-metrics/src/sink/apiv2_sink","typescript/libraries/shared/apex-metrics/src/sink/apiv2_sink"],(function(e,t,i,n,s,r){"use strict";function a(){return new i.BrowserPerformanceClock}Object.defineProperty(t,"__esModule",{value:!0}),t.getSinkSingleton=t.getMetricsReporter=t.makeDefaultCacheFactory=t.PlatformDetector=t.ExceptionReporter=t.ExcSeverity=t.ClientFactory=t.CacheFactory=t.BrowserName=void 0,Object.defineProperty(t,"BrowserName",{enumerable:!0,get:function(){return r.BrowserName}}),Object.defineProperty(t,"CacheFactory",{enumerable:!0,get:function(){return r.CacheFactory}}),Object.defineProperty(t,"ClientFactory",{enumerable:!0,get:function(){return r.ClientFactory}}),Object.defineProperty(t,"ExcSeverity",{enumerable:!0,get:function(){return r.ExcSeverity}}),Object.defineProperty(t,"ExceptionReporter",{enumerable:!0,get:function(){return r.ExceptionReporter}}),Object.defineProperty(t,"PlatformDetector",{enumerable:!0,get:function(){return r.PlatformDetector}}),Object.defineProperty(t,"makeDefaultCacheFactory",{enumerable:!0,get:function(){return r.makeDefaultCacheFactory}});const o=(0,s.makeDefaultCacheFactory)();function c(e){var t;let{clientFactory:r,platformDetector:c,exceptionReporter:l,identifierFactory:d}=e,u=null===(t=window.sinkSingleton)||void 0===t?void 0:t.clientFactory;if(void 0!==u&&(r=u),void 0===c&&(c=(0,s.makeNopPlatformDetector)()),void 0===l&&(l=(0,s.makeNopExceptionReporter)()),void 0===d&&(d=()=>""),window.sinkSingleton)return window.sinkSingleton.clientFactory=r,window.sinkSingleton;const p=new s.Apiv2MetricsSink(r,a(),(0,s.makeDefaultInitialization)(r,c,l),o,new i.SetTimeoutExecutor(()=>({value:5*Math.random(),unit:i.TimeUnit.SECONDS})),Math.random,n.getDatabase,c,l,d);return window.sinkSingleton=p,p}t.getMetricsReporter=function(e){const t=c(e);return i.MetricsReporterImpl.root(t,a(),t.getOriginId())},t.getSinkSingleton=c})),define("typescript/libraries/shared/apex-metrics/src/sink/instrumentation",["require","exports","typescript/libraries/shared/apex-metrics/src/index","typescript/libraries/shared/apex-metrics/src/sink/serialization"],(function(e,t,i,n){"use strict";function s(e,t,i,n){i("samples_sink/submitted_spans",e.submittedSpans),i("samples_sink/submitted_samples",e.submittedSamples);for(const[t,n]of Object.entries(e.submittedSamplesByNs))i("samples_sink/submitted_samples_by_ns",n,{namespace:t});i("samples_sink/retained_spans",e.retainedSpans),i("samples_sink/retained_samples",e.retainedSamples);for(const[t,n]of Object.entries(e.retainedSamplesByNs))i("samples_sink/retained_samples_by_ns",n,{namespace:t});i("samples_sink/request/dropped_samples",e.requestDroppedSamples),i("samples_sink/request/dropped_spans",e.requestDroppedSpans),i("samples_sink/request/attempts",e.requestAttempts),i("samples_sink/request/latency",t),i("samples_sink/submitted_set_observations",e.setObservations);for(const[t,n]of Object.entries(e.setObservationsByNs))i("samples_sink/submitted_set_observations_by_ns",n,{namespace:t});i("samples_sink/request/dropped_set_observations",e.requestDroppedSetObservations),n("samples_sink/reporting_hosts")}Object.defineProperty(t,"__esModule",{value:!0}),t.Instrumentation=t.SELF_INSTRUMENTATION_NAMESPACE=void 0,t.SELF_INSTRUMENTATION_NAMESPACE="amp_client",(function(e){function r(e,t){var i;const n=Object.assign({},e);for(const[e,s]of Object.entries(t))n[e]=(null!==(i=n[e])&&void 0!==i?i:0)+s;return n}e.empty=function(){return{submittedSpans:0,submittedSamples:0,submittedSamplesByNs:{},retainedSpans:0,retainedSamples:0,retainedSamplesByNs:{},requestDroppedSamples:0,requestDroppedSpans:0,requestAttempts:0,setObservations:0,setObservationsByNs:{},requestDroppedSetObservations:0}},e.incrementSubmittedSamples=function(e,t,i){e.submittedSamples+=i;const n=e.submittedSamplesByNs[t];e.submittedSamplesByNs[t]=(null!=n?n:0)+i},e.incrementSetObservations=function(e,t,i){e.setObservations+=i;const n=e.setObservationsByNs[t];e.setObservationsByNs[t]=(null!=n?n:0)+i},e.incrementRetainedSamples=function(e,t,i){e.retainedSamples+=i;const n=e.retainedSamplesByNs[t];e.retainedSamplesByNs[t]=(null!=n?n:0)+i},e.report=function(i,n,r,a){if(0===i.retainedSamples)return i.requestAttempts=0,i;const o=n.child({client_version:a.toString()});return s(i,r,(e,i,n)=>{o.createStats({ns:t.SELF_INSTRUMENTATION_NAMESPACE,name:e},n).record(i)},e=>{o.createSet({ns:t.SELF_INSTRUMENTATION_NAMESPACE,name:e}).observeOriginId()}),e.empty()},e.toScope=function(e,r,a,o){const c=[];return s(e,a,(e,t,i)=>{c.push({tags:i?(0,n.formatTags)(i):[],metrics:[{name:{value:{".tag":"string_value",string_value:e}},data:{".tag":"numerical_data",samples:[t]}}]})},e=>{c.push({metrics:[{name:{value:{".tag":"string_value",string_value:e}},data:{".tag":"set_data",samples:[(0,i.hash)(r)]}}]})}),{metric_namespace:t.SELF_INSTRUMENTATION_NAMESPACE,timestamp_sec:Math.floor(Date.now()/1e3),tags:(0,n.formatTags)(o),descendants:c}},e.merge=function(e,t){var i,n,s,a,o,c,l,d,u,p,m,_;return{submittedSpans:e.submittedSpans+(null!==(i=t.submittedSpans)&&void 0!==i?i:0),submittedSamples:e.submittedSamples+(null!==(n=t.submittedSamples)&&void 0!==n?n:0),submittedSamplesByNs:r(e.submittedSamplesByNs,null!==(s=t.submittedSamplesByNs)&&void 0!==s?s:{}),retainedSpans:e.retainedSpans+(null!==(a=t.retainedSpans)&&void 0!==a?a:0),retainedSamples:e.retainedSamples+(null!==(o=t.retainedSamples)&&void 0!==o?o:0),retainedSamplesByNs:r(e.retainedSamplesByNs,null!==(c=t.retainedSamplesByNs)&&void 0!==c?c:{}),requestDroppedSamples:e.requestDroppedSamples+(null!==(l=t.requestDroppedSamples)&&void 0!==l?l:0),requestDroppedSpans:e.requestDroppedSpans+(null!==(d=t.requestDroppedSpans)&&void 0!==d?d:0),requestAttempts:e.requestAttempts+(null!==(u=t.requestAttempts)&&void 0!==u?u:0),setObservations:e.setObservations+(null!==(p=t.setObservations)&&void 0!==p?p:0),setObservationsByNs:r(e.setObservationsByNs,null!==(m=t.setObservationsByNs)&&void 0!==m?m:{}),requestDroppedSetObservations:e.requestDroppedSetObservations+(null!==(_=t.requestDroppedSetObservations)&&void 0!==_?_:0)}}})(t.Instrumentation||(t.Instrumentation={}))})),define("typescript/libraries/shared/apex-metrics/src/sink/serialization",["require","exports","@bufbuild/protobuf"],(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.unmarshalProto=t.marshalProto=t.zipTags=t.formatTags=void 0,t.formatTags=function(e){const t=[];for(const i in e)if(e.hasOwnProperty(i)){const n=e[i];t.push({name:{value:{".tag":"string_value",string_value:i}},value:{value:{".tag":"string_value",string_value:n}}})}return t},t.zipTags=function(e,t){if(e.length!==t.length)throw new Error("Cannot zip values of different dimensions!");return e.map((e,i)=>({name:{value:{".tag":"string_value",string_value:e}},value:{value:{".tag":"string_value",string_value:t[i]}}}))},t.marshalProto=function(e){return i.protoBase64.enc(e.toBinary())},t.unmarshalProto=function(e,t){const n=i.protoBase64.dec(e);return t.fromBinary(n)}}));
//# sourceMappingURL=pkg-timing.min.js-vflsB0IbJ.map